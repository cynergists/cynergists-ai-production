import{r as n,s as h,j as e,m as xe,B as S,n as V,e as T,T as ue,h as D,D as he,i as pe,U as fe,C as je,Q as ge,z as _e,J as ne}from"./app-C9sJHYCL.js";import{C as E,a as F,b as ve}from"./card-xM_T_QEq.js";import{I as ae}from"./input-BIyZmrfA.js";import{T as Ne,a as we,b as K,c as u,d as ye,e as o}from"./table-DvSgZRYl.js";import{T as be,a as Se,b as M,c as U}from"./tabs-BywZ5jok.js";import{S as Ce,a as De,b as Te,c as Pe}from"./sheet-B5E0spRs.js";import{L as Q}from"./label-CON6LZW3.js";import{T as Ae}from"./textarea-Ho9uOiBu.js";import{S as X,a as Y,b as Z,c as ee,d as C}from"./select-Bb_vAbk5.js";import{S as se}from"./separator-CiQJM0oX.js";import{S as Ie}from"./scroll-area-C84zghn6.js";import{D as Le,a as Be,c as Ee,d as Fe,f as Me}from"./dialog-DAfnVAW3.js";import{u as Ue}from"./useAutoSave-HL8hQ_b2.js";import{B as Ve}from"./building-2-f0Ey5RTe.js";import{U as ke}from"./user-KPGr3U8Z.js";import{C as Oe}from"./copy-mSe4nMDe.js";import{P as qe}from"./phone-B-kOTN5P.js";import{M as Re}from"./message-square-CM_Sw1Io.js";import{f as J}from"./formatDistanceToNow-BUVPt8LP.js";import{T as We}from"./triangle-alert-BgzkvxgC.js";import{T as He}from"./trending-up-Dhn98mOj.js";/* empty css            */import"./index-DWjtwfXH.js";import"./index-mEKJzlVy.js";import"./index-qTvOvuVq.js";import"./Combination-Bv4OtcuM.js";import"./index-B3oBxWiH.js";import"./index-BdQq_4o_.js";import"./index-H_9W4N8N.js";import"./check-BybgecC6.js";import"./chevron-up-CyWMtqZ2.js";import"./index-Dx1E_Pz2.js";import"./endOfMonth-Du0-bqD0.js";import"./endOfDay-DznVaLJG.js";const $e=[{value:"new",label:"New"},{value:"in_progress",label:"In Progress"},{value:"closed_won",label:"Closed Won"},{value:"closed_lost",label:"Closed Lost"}];function ze({deal:a,isOpen:N,onClose:k,onUpdate:c}){const[g,d]=n.useState({}),[P,_]=n.useState([]),[O,q]=n.useState([]),[A,G]=n.useState([]),[p,R]=n.useState(""),[w,W]=n.useState("admin"),[f,i]=n.useState(!1),[H,j]=n.useState(!1),[m,I]=n.useState(null),[L,$]=n.useState(null);n.useEffect(()=>{a&&(d({stage:a.stage,deal_value:a.deal_value,expected_close_date:a.expected_close_date,partner_id:a.partner_id}),x(),t(),r())},[a]);const x=async()=>{if(!a)return;const{data:s}=await h.from("deal_notes").select("*").eq("deal_id",a.id).order("created_at",{ascending:!1});_(s||[])},t=async()=>{if(!a)return;const{data:s}=await h.from("referrals").select("id, lead_name, lead_email, source, event_type, duplicate, status, created_at").eq("deal_id",a.id).order("created_at",{ascending:!1});q(s||[])},r=async()=>{const{data:s}=await h.from("partners").select("id, first_name, last_name, slug").in("partner_status",["active","pending"]).order("first_name");G(s||[])},y=n.useMemo(()=>a?{stage:a.stage,deal_value:a.deal_value,expected_close_date:a.expected_close_date,partner_id:a.partner_id}:null,[a]),z=n.useCallback(async s=>{if(!a)return!1;try{const l={stage:s.stage,deal_value:s.deal_value||0,expected_close_date:s.expected_close_date||null,last_activity_at:new Date().toISOString()};(s.stage==="closed_won"||s.stage==="closed_lost")&&(l.closed_at=new Date().toISOString());const{error:v}=await h.from("partner_deals").update(l).eq("id",a.id);if(v)throw v;return c(),!0}catch(l){return console.error("Error updating deal:",l),!1}},[a,c]),{isSaving:b}=Ue({data:g,onSave:z,enabled:!!a&&N,initialData:y}),ce=s=>{if(s==="unassigned"){d(l=>({...l,partner_id:null}));return}a?.partner_id&&a.partner_id!==s?($(a.partner_id),I(s),j(!0)):d(l=>({...l,partner_id:s}))},oe=async()=>{if(!(!a||!m))try{const s=A.find(B=>B.id===L),l=A.find(B=>B.id===m),v=s?[s.first_name,s.last_name].filter(Boolean).join(" "):"None",re=l?[l.first_name,l.last_name].filter(Boolean).join(" "):"None",{error:le}=await h.from("partner_deals").update({partner_id:m,last_activity_at:new Date().toISOString()}).eq("id",a.id);if(le)throw le;await h.rpc("add_deal_note",{p_deal_id:a.id,p_note_text:`Partner attribution updated by admin from "${v}" to "${re}"`,p_note_type:"admin"}),await h.from("partner_audit_logs").insert({partner_id:m,action:"deal_attribution_changed",resource_type:"deal",resource_id:a.id,old_value:{partner_id:L,partner_name:v},new_value:{partner_id:m,partner_name:re}}),d(B=>({...B,partner_id:m})),D.success("Partner updated"),x(),c()}catch(s){console.error("Error updating partner:",s),D.error("Failed to update partner")}finally{j(!1),I(null),$(null)}},de=async()=>{if(!(!a||!p.trim())){i(!0);try{await h.rpc("add_deal_note",{p_deal_id:a.id,p_note_text:p.trim(),p_note_type:w}),R(""),D.success("Note added"),x(),c()}catch(s){console.error("Error adding note:",s),D.error("Failed to add note")}finally{i(!1)}}},me=s=>{navigator.clipboard.writeText(s),D.success("Copied to clipboard")},te=s=>{if(!s)return"Unassigned";const l=A.find(v=>v.id===s);return l?[l.first_name,l.last_name].filter(Boolean).join(" ")||l.slug:"Unknown"};return a?e.jsxs(e.Fragment,{children:[e.jsx(Ce,{open:N,onOpenChange:k,children:e.jsxs(De,{className:"w-full sm:max-w-xl overflow-hidden flex flex-col",children:[e.jsx(Te,{children:e.jsxs(Pe,{className:"flex items-center gap-2",children:[e.jsx(Ve,{className:"h-5 w-5"}),a.client_company||a.client_name]})}),e.jsx(Ie,{className:"flex-1 -mx-6 px-6",children:e.jsxs("div",{className:"space-y-6 pb-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:"Contact Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ke,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:a.client_name})]}),a.client_email&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"truncate",children:a.client_email}),e.jsx(S,{size:"icon",variant:"ghost",className:"h-6 w-6",onClick:()=>me(a.client_email),children:e.jsx(Oe,{className:"h-3 w-3"})})]}),a.client_phone&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:a.client_phone})]})]})]}),e.jsx(se,{}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:"Deal Details"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Stage"}),e.jsxs(X,{value:g.stage||a.stage,onValueChange:s=>d(l=>({...l,stage:s})),children:[e.jsx(Y,{children:e.jsx(Z,{})}),e.jsx(ee,{children:$e.map(s=>e.jsx(C,{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Deal Value ($)"}),e.jsx(ae,{type:"number",value:g.deal_value??a.deal_value??"",onChange:s=>d(l=>({...l,deal_value:parseFloat(s.target.value)||0})),placeholder:"0"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Expected Close Date"}),e.jsx(ae,{type:"date",value:g.expected_close_date?.split("T")[0]||a.expected_close_date?.split("T")[0]||"",onChange:s=>d(l=>({...l,expected_close_date:s.target.value||null}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Q,{children:"Partner Attribution"}),e.jsxs(X,{value:g.partner_id||a.partner_id||"unassigned",onValueChange:ce,children:[e.jsx(Y,{children:e.jsx(Z,{placeholder:"Select partner..."})}),e.jsxs(ee,{children:[e.jsx(C,{value:"unassigned",children:"Unassigned"}),A.map(s=>e.jsx(C,{value:s.id,children:[s.first_name,s.last_name].filter(Boolean).join(" ")||s.slug},s.id))]})]})]}),e.jsx("div",{className:"flex items-center gap-2 text-sm text-muted-foreground h-9",children:b&&e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"h-3 w-3 animate-spin"}),e.jsx("span",{children:"Saving..."})]})})]}),e.jsx(se,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:"Add Note"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(X,{value:w,onValueChange:W,children:[e.jsx(Y,{className:"w-[180px]",children:e.jsx(Z,{})}),e.jsxs(ee,{children:[e.jsx(C,{value:"admin",children:"Admin Only"}),e.jsx(C,{value:"partner_visible",children:"Partner Visible"}),e.jsx(C,{value:"system",children:"System"})]})]}),e.jsx(Ae,{placeholder:"Add a note...",value:p,onChange:s=>R(s.target.value),rows:2}),e.jsxs(S,{size:"sm",onClick:de,disabled:f||!p.trim(),children:[f?e.jsx(V,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(Re,{className:"h-4 w-4 mr-2"}),"Add Note"]})]})]}),e.jsx(se,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium text-sm text-muted-foreground",children:"Timeline"}),e.jsxs("div",{className:"space-y-3",children:[P.map(s=>e.jsxs("div",{className:"border rounded-lg p-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(T,{variant:s.note_type==="admin"?"destructive":s.note_type==="partner_visible"?"secondary":"outline",className:"text-xs",children:s.note_type}),e.jsx("span",{className:"text-muted-foreground text-xs",children:J(new Date(s.created_at),{addSuffix:!0})})]}),e.jsx("p",{children:s.note_text})]},s.id)),O.map(s=>e.jsxs("div",{className:"border rounded-lg p-3 text-sm bg-muted/30",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(T,{variant:"outline",className:"text-xs",children:"Referral"}),s.duplicate&&e.jsx(T,{variant:"outline",className:"text-xs bg-orange-500/10",children:"Duplicate"}),e.jsx("span",{className:"text-muted-foreground text-xs",children:J(new Date(s.created_at),{addSuffix:!0})})]}),e.jsxs("p",{className:"text-muted-foreground",children:[s.lead_name||s.lead_email," - ",s.event_type||s.source||"Unknown source"]})]},s.id)),a.timeline&&Array.isArray(a.timeline)&&a.timeline.map((s,l)=>e.jsxs("div",{className:"border rounded-lg p-3 text-sm bg-muted/10",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(T,{variant:"outline",className:"text-xs",children:s.type}),e.jsx("span",{className:"text-muted-foreground text-xs",children:s.timestamp?J(new Date(s.timestamp),{addSuffix:!0}):""})]}),e.jsx("p",{children:s.message})]},l)),P.length===0&&O.length===0&&(!a.timeline||a.timeline.length===0)&&e.jsx("p",{className:"text-muted-foreground text-sm text-center py-4",children:"No timeline entries yet"})]})]})]})}),e.jsxs("div",{className:"flex items-center gap-2 pt-4 border-t mt-auto",children:[e.jsxs(S,{variant:"destructive",className:"flex-1",disabled:!0,children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),"Delete",b&&e.jsx(V,{className:"h-3 w-3 ml-2 animate-spin"})]}),e.jsx(S,{variant:"outline",className:"flex-1",onClick:k,children:"Close"})]})]})}),e.jsx(Le,{open:H,onOpenChange:j,children:e.jsxs(Be,{children:[e.jsx(Ee,{children:e.jsxs(Fe,{className:"flex items-center gap-2",children:[e.jsx(We,{className:"h-5 w-5 text-yellow-500"}),"Change Partner Attribution"]})}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Changing partner attribution will affect commissions for this deal. Are you sure you want to change from ",e.jsx("strong",{children:te(L)})," to ",e.jsx("strong",{children:te(m)}),"?"]}),e.jsxs(Me,{children:[e.jsx(S,{variant:"outline",onClick:()=>{j(!1),I(null)},children:"Cancel"}),e.jsxs(S,{onClick:oe,disabled:b,children:[b?e.jsx(V,{className:"h-4 w-4 animate-spin mr-2"}):null,"Confirm Change"]})]})]})})]}):null}const ie={new:{label:"New",variant:"default",color:"bg-blue-500"},in_progress:{label:"In Progress",variant:"secondary",color:"bg-yellow-500"},closed_won:{label:"Closed Won",variant:"default",color:"bg-green-500"},closed_lost:{label:"Closed Lost",variant:"destructive",color:"bg-red-500"}};function Ds(){const{url:a}=he(),N=n.useMemo(()=>new URLSearchParams(a.split("?")[1]??""),[a]),k=n.useCallback(t=>{const r=t.toString();pe.visit(`/admin/deals${r?`?${r}`:""}`,{replace:!0,preserveState:!0,preserveScroll:!0})},[]),[c,g]=n.useState([]),[d,P]=n.useState(!0),[_,O]=n.useState(""),[q,A]=n.useState("all"),[G,p]=n.useState(null),[R,w]=n.useState(!1),W=async()=>{P(!0);try{const{data:t,error:r}=await h.from("partner_deals").select("*, partners(first_name, last_name, slug)").order("created_at",{ascending:!1});if(r)throw r;g(t||[]);const y=N.get("dealId");if(y&&t){const z=t.find(b=>b.id===y);z&&(p(z),w(!0),N.delete("dealId"),k(N))}}catch(t){console.error("Error fetching deals:",t),D.error("Failed to load deals")}finally{P(!1)}};n.useEffect(()=>{W()},[]);const f=c.filter(t=>{const r=!_||t.client_name?.toLowerCase().includes(_.toLowerCase())||t.client_email?.toLowerCase().includes(_.toLowerCase())||t.client_company?.toLowerCase().includes(_.toLowerCase()),y=q==="all"||t.stage===q;return r&&y}),i={all:f,new:f.filter(t=>t.stage==="new"),in_progress:f.filter(t=>t.stage==="in_progress"),closed_won:f.filter(t=>t.stage==="closed_won"),closed_lost:f.filter(t=>t.stage==="closed_lost")},H=t=>t.partners?[t.partners.first_name,t.partners.last_name].filter(Boolean).join(" ")||t.partners.slug:null,j=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(t),m=c.reduce((t,r)=>t+(r.deal_value||0),0),I=c.filter(t=>t.stage==="closed_won").reduce((t,r)=>t+(r.deal_value||0),0),L=c.filter(t=>["new","in_progress"].includes(t.stage)).length,$=()=>{W()},x=t=>e.jsxs(Ne,{children:[e.jsx(we,{children:e.jsxs(K,{children:[e.jsx(u,{children:"Stage"}),e.jsx(u,{children:"Company"}),e.jsx(u,{children:"Contact"}),e.jsx(u,{children:"Email"}),e.jsx(u,{children:"Value"}),e.jsx(u,{children:"Close Date"}),e.jsx(u,{children:"Partner"}),e.jsx(u,{children:"Last Activity"}),e.jsx(u,{children:"Created"})]})}),e.jsxs(ye,{children:[t.map(r=>e.jsxs(K,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>{p(r),w(!0)},children:[e.jsx(o,{children:e.jsx(T,{variant:ie[r.stage]?.variant||"outline",children:ie[r.stage]?.label||r.stage})}),e.jsx(o,{className:"font-medium",children:r.client_company||"—"}),e.jsx(o,{children:r.client_name}),e.jsx(o,{children:r.client_email||"—"}),e.jsx(o,{children:r.deal_value?j(r.deal_value):"—"}),e.jsx(o,{children:r.expected_close_date?ne(new Date(r.expected_close_date),"MMM d, yyyy"):"TBD"}),e.jsx(o,{children:H(r)?e.jsx(T,{variant:"outline",children:H(r)}):e.jsx("span",{className:"text-muted-foreground",children:"Unassigned"})}),e.jsx(o,{className:"text-muted-foreground text-sm",children:r.last_activity_at?J(new Date(r.last_activity_at),{addSuffix:!0}):"—"}),e.jsx(o,{className:"text-muted-foreground text-sm",children:ne(new Date(r.created_at),"MMM d, yyyy")})]},r.id)),t.length===0&&e.jsx(K,{children:e.jsx(o,{colSpan:9,className:"text-center py-8 text-muted-foreground",children:"No deals found"})})]})]});return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Deals Pipeline"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage partner deals and track progress"})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(E,{children:e.jsx(F,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Deals"}),e.jsx("p",{className:"text-2xl font-bold",children:c.length})]}),e.jsx(fe,{className:"h-8 w-8 text-muted-foreground"})]})})}),e.jsx(E,{children:e.jsx(F,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Open Deals"}),e.jsx("p",{className:"text-2xl font-bold",children:L})]}),e.jsx(je,{className:"h-8 w-8 text-muted-foreground"})]})})}),e.jsx(E,{children:e.jsx(F,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Pipeline Value"}),e.jsx("p",{className:"text-2xl font-bold",children:j(m)})]}),e.jsx(He,{className:"h-8 w-8 text-muted-foreground"})]})})}),e.jsx(E,{children:e.jsx(F,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Won Value"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:j(I)})]}),e.jsx(ge,{className:"h-8 w-8 text-green-600"})]})})})]}),e.jsxs(E,{children:[e.jsx(ve,{children:e.jsx("div",{className:"flex flex-col sm:flex-row gap-4",children:e.jsxs("div",{className:"relative flex-1",children:[e.jsx(_e,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ae,{placeholder:"Search by company, contact, or email...",value:_,onChange:t=>O(t.target.value),className:"pl-10"})]})})}),e.jsx(F,{children:d?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(V,{className:"h-6 w-6 animate-spin"})}):e.jsxs(be,{defaultValue:"all",className:"w-full",children:[e.jsxs(Se,{className:"mb-4",children:[e.jsxs(M,{value:"all",children:["All (",i.all.length,")"]}),e.jsxs(M,{value:"new",children:["New (",i.new.length,")"]}),e.jsxs(M,{value:"in_progress",children:["In Progress (",i.in_progress.length,")"]}),e.jsxs(M,{value:"closed_won",children:["Closed Won (",i.closed_won.length,")"]}),e.jsxs(M,{value:"closed_lost",children:["Closed Lost (",i.closed_lost.length,")"]})]}),e.jsx(U,{value:"all",className:"overflow-x-auto",children:x(i.all)}),e.jsx(U,{value:"new",className:"overflow-x-auto",children:x(i.new)}),e.jsx(U,{value:"in_progress",className:"overflow-x-auto",children:x(i.in_progress)}),e.jsx(U,{value:"closed_won",className:"overflow-x-auto",children:x(i.closed_won)}),e.jsx(U,{value:"closed_lost",className:"overflow-x-auto",children:x(i.closed_lost)})]})})]}),e.jsx(ze,{deal:G,isOpen:R,onClose:()=>{w(!1),p(null)},onUpdate:$})]})}export{Ds as default};
