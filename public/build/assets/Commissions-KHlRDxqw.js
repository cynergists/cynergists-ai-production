import{w as de,r as l,u as oe,j as e,H as ce,R as me,B as n,m as k,V as ue,aN as xe,g as he,K as x,e as je,h,s as _}from"./app-yl1YHj2k.js";import{u as Q}from"./useMutation-Dt0Tk2fE.js";import{C as c,b as j,d as p,a as m,c as pe}from"./card-Dxx2nlaR.js";import{I as J}from"./input-B3tD5KH9.js";import{T as ge,a as fe,b as W,c as i,d as ye,e as d}from"./table-Digz5nhl.js";import{S as be,a as Ne,b as we,c as Ce,d as g}from"./select-bZyWIIk8.js";import{D as S,g as ve,a as D,c as M,d as A,e as G,f as K}from"./dialog-B01Lxjmp.js";import{T as U}from"./textarea-CY5CbXPo.js";import{L as T}from"./label-C79MsPnt.js";import{R as ke}from"./refresh-cw-BzMi6-fJ.js";import{F as _e}from"./filter-DvbsL620.js";import{T as Se}from"./triangle-alert-SZFjwlm_.js";import{C as X}from"./circle-check-CXfnWLUV.js";import{E as De}from"./eye-CeU3PbrC.js";import{M as Me}from"./message-square-CXNrGOna.js";import{S as Ae}from"./square-pen-Brf1ugm5.js";import{B as Te}from"./ban-h8Xxc6a_.js";/* empty css            */import"./index-BdQq_4o_.js";import"./index-KgiDK8vA.js";import"./Combination-BU6xJxfT.js";import"./index-B4oGC8tk.js";import"./check-3ows1Yys.js";import"./chevron-up-CP4UIDax.js";import"./index-DC5Tape7.js";import"./index-ClWG0nRm.js";const Y={pending:{label:"Pending",icon:he,className:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400"},earned:{label:"Earned",icon:X,className:"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400"},payable:{label:"Payable",icon:xe,className:"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400"},paid:{label:"Paid",icon:X,className:"bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400"},clawed_back:{label:"Clawed Back",icon:Se,className:"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400"},disputed:{label:"Disputed",icon:ue,className:"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400"}};function rs(){const E=de(),[f,Z]=l.useState("all"),[b,ee]=l.useState(""),[r,P]=l.useState(null),[F,z]=l.useState(""),[R,O]=l.useState(""),[$,q]=l.useState(""),[H,V]=l.useState(""),[se,N]=l.useState(!1),[ae,w]=l.useState(!1),[te,C]=l.useState(!1),{data:re,isLoading:ne,refetch:le}=oe({queryKey:["admin-commissions",f,b],queryFn:async()=>{let s=_.from("partner_commissions").select(`
          *,
          partner:partners!partner_commissions_partner_id_fkey(first_name, last_name),
          customer:clients!partner_commissions_customer_id_fkey(name, company)
        `).order("created_at",{ascending:!1}).limit(100);f&&f!=="all"&&(s=s.eq("status",f));const{data:a,error:t}=await s;if(t)throw t;return a}}),B=Q({mutationFn:async({id:s,reason:a})=>{const{error:t}=await _.from("partner_commissions").update({status:"disputed",notes:(r?.notes||"")+`
[${x(new Date,"yyyy-MM-dd HH:mm")}] DISPUTED: ${a}`}).eq("id",s);if(t)throw t},onSuccess:()=>{h.success("Commission marked as disputed"),E.invalidateQueries({queryKey:["admin-commissions"]}),N(!1),z("")},onError:s=>{h.error("Failed to mark as disputed: "+s.message)}}),L=Q({mutationFn:async({id:s,note:a})=>{const{error:t}=await _.from("partner_commissions").update({notes:(r?.notes||"")+`
[${x(new Date,"yyyy-MM-dd HH:mm")}] NOTE: ${a}`}).eq("id",s);if(t)throw t},onSuccess:()=>{h.success("Note added"),E.invalidateQueries({queryKey:["admin-commissions"]}),w(!1),O("")},onError:s=>{h.error("Failed to add note: "+s.message)}}),I=Q({mutationFn:async({id:s,newAmount:a,reason:t})=>{const{error:v}=await _.from("partner_commissions").update({net_amount:a,notes:(r?.notes||"")+`
[${x(new Date,"yyyy-MM-dd HH:mm")}] ADJUSTED: $${r?.net_amount} -> $${a}. Reason: ${t}`}).eq("id",s);if(v)throw v},onSuccess:()=>{h.success("Commission adjusted"),E.invalidateQueries({queryKey:["admin-commissions"]}),C(!1),q(""),V("")},onError:s=>{h.error("Failed to adjust commission: "+s.message)}}),u=s=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2}).format(s),o=re?.filter(s=>{if(!b)return!0;const a=b.toLowerCase(),t=`${s.partner?.first_name||""} ${s.partner?.last_name||""}`.toLowerCase(),v=s.customer?.name?.toLowerCase()||"",ie=s.customer?.company?.toLowerCase()||"";return t.includes(a)||v.includes(a)||ie.includes(a)})||[],y={earned:o.filter(s=>s.status==="earned").reduce((s,a)=>s+a.net_amount,0),payable:o.filter(s=>s.status==="payable").reduce((s,a)=>s+a.net_amount,0),paid:o.filter(s=>s.status==="paid").reduce((s,a)=>s+a.net_amount,0),clawedBack:o.filter(s=>s.status==="clawed_back").length,disputed:o.filter(s=>s.status==="disputed").length};return e.jsxs("div",{className:"space-y-6",children:[e.jsx(ce,{children:e.jsx("title",{children:"Commissions | Admin"})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(me,{className:"h-6 w-6"}),"Commissions Management"]}),e.jsx("p",{className:"text-muted-foreground",children:"View and manage partner commissions"})]}),e.jsxs(n,{variant:"outline",onClick:()=>le(),children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Refresh"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs(c,{children:[e.jsx(j,{className:"pb-2",children:e.jsx(p,{children:"Earned"})}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:u(y.earned)})})]}),e.jsxs(c,{children:[e.jsx(j,{className:"pb-2",children:e.jsx(p,{children:"Payable"})}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold text-green-600",children:u(y.payable)})})]}),e.jsxs(c,{children:[e.jsx(j,{className:"pb-2",children:e.jsx(p,{children:"Total Paid"})}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold text-emerald-600",children:u(y.paid)})})]}),e.jsxs(c,{children:[e.jsx(j,{className:"pb-2",children:e.jsx(p,{children:"Clawed Back"})}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold text-red-600",children:y.clawedBack})})]}),e.jsxs(c,{children:[e.jsx(j,{className:"pb-2",children:e.jsx(p,{children:"Disputed"})}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:y.disputed})})]})]}),e.jsx(c,{children:e.jsx(m,{className:"pt-4",children:e.jsxs("div",{className:"flex flex-wrap gap-4 items-end",children:[e.jsx("div",{className:"flex-1 min-w-[200px]",children:e.jsx(J,{placeholder:"Search by partner or customer...",value:b,onChange:s=>ee(s.target.value),className:"max-w-sm"})}),e.jsxs(be,{value:f,onValueChange:Z,children:[e.jsxs(Ne,{className:"w-[180px]",children:[e.jsx(_e,{className:"h-4 w-4 mr-2"}),e.jsx(we,{placeholder:"Filter by status"})]}),e.jsxs(Ce,{children:[e.jsx(g,{value:"all",children:"All Status"}),e.jsx(g,{value:"earned",children:"Earned"}),e.jsx(g,{value:"payable",children:"Payable"}),e.jsx(g,{value:"paid",children:"Paid"}),e.jsx(g,{value:"clawed_back",children:"Clawed Back"}),e.jsx(g,{value:"disputed",children:"Disputed"})]})]})]})})}),e.jsxs(c,{children:[e.jsxs(j,{children:[e.jsx(pe,{children:"All Commissions"}),e.jsxs(p,{children:[o.length," commissions found"]})]}),e.jsx(m,{children:ne?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(k,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):o.length===0?e.jsx("div",{className:"text-center py-12 text-muted-foreground",children:"No commissions found"}):e.jsxs(ge,{children:[e.jsx(fe,{children:e.jsxs(W,{children:[e.jsx(i,{children:"Earned"}),e.jsx(i,{children:"Partner"}),e.jsx(i,{children:"Customer"}),e.jsx(i,{className:"text-right",children:"Basis"}),e.jsx(i,{className:"text-right",children:"Rate"}),e.jsx(i,{className:"text-right",children:"Commission"}),e.jsx(i,{children:"Status"}),e.jsx(i,{children:"Payable At"}),e.jsx(i,{children:"Clawback Until"}),e.jsx(i,{children:"Actions"})]})}),e.jsx(ye,{children:o.map(s=>{const a=Y[s.status]||Y.earned,t=a.icon;return e.jsxs(W,{children:[e.jsx(d,{className:"text-sm",children:s.earned_at?x(new Date(s.earned_at),"MMM d, yyyy"):"-"}),e.jsx(d,{children:s.partner?`${s.partner.first_name} ${s.partner.last_name}`:"-"}),e.jsx(d,{children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.customer?.name||"-"}),s.customer?.company&&e.jsx("div",{className:"text-xs text-muted-foreground",children:s.customer.company})]})}),e.jsx(d,{className:"text-right text-muted-foreground",children:u(s.gross_amount)}),e.jsxs(d,{className:"text-right",children:[Math.round(s.commission_rate*100),"%"]}),e.jsx(d,{className:"text-right font-semibold",children:u(s.net_amount)}),e.jsx(d,{children:e.jsxs(je,{className:a.className,children:[e.jsx(t,{className:"h-3 w-3 mr-1"}),a.label]})}),e.jsx(d,{className:"text-sm text-muted-foreground",children:s.payable_at?x(new Date(s.payable_at),"MMM d, yyyy"):"-"}),e.jsx(d,{className:"text-sm text-muted-foreground",children:s.clawback_eligible_until?x(new Date(s.clawback_eligible_until),"MMM d, yyyy"):"-"}),e.jsx(d,{children:e.jsxs("div",{className:"flex gap-1",children:[s.notes&&e.jsxs(S,{children:[e.jsx(ve,{asChild:!0,children:e.jsx(n,{variant:"ghost",size:"sm",children:e.jsx(De,{className:"h-4 w-4"})})}),e.jsxs(D,{children:[e.jsx(M,{children:e.jsx(A,{children:"Commission Notes"})}),e.jsx("pre",{className:"text-sm whitespace-pre-wrap bg-muted p-4 rounded max-h-[400px] overflow-auto",children:s.notes})]})]}),e.jsx(n,{variant:"ghost",size:"sm",onClick:()=>{P(s),w(!0)},children:e.jsx(Me,{className:"h-4 w-4"})}),s.status!=="disputed"&&s.status!=="clawed_back"&&s.status!=="paid"&&e.jsxs(e.Fragment,{children:[e.jsx(n,{variant:"ghost",size:"sm",onClick:()=>{P(s),q(s.net_amount.toString()),C(!0)},children:e.jsx(Ae,{className:"h-4 w-4"})}),e.jsx(n,{variant:"ghost",size:"sm",onClick:()=>{P(s),N(!0)},children:e.jsx(Te,{className:"h-4 w-4"})})]})]})})]},s.id)})})]})})]}),e.jsx(S,{open:se,onOpenChange:N,children:e.jsxs(D,{children:[e.jsxs(M,{children:[e.jsx(A,{children:"Mark Commission as Disputed"}),e.jsx(G,{children:"This will flag the commission for review. Please provide a reason."})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx(T,{children:"Reason for dispute"}),e.jsx(U,{value:F,onChange:s=>z(s.target.value),placeholder:"Enter the reason..."})]})}),e.jsxs(K,{children:[e.jsx(n,{variant:"outline",onClick:()=>N(!1),children:"Cancel"}),e.jsxs(n,{variant:"destructive",onClick:()=>r&&B.mutate({id:r.id,reason:F}),disabled:!F||B.isPending,children:[B.isPending?e.jsx(k,{className:"h-4 w-4 animate-spin mr-2"}):null,"Mark Disputed"]})]})]})}),e.jsx(S,{open:ae,onOpenChange:w,children:e.jsxs(D,{children:[e.jsx(M,{children:e.jsx(A,{children:"Add Admin Note"})}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsx(T,{children:"Note"}),e.jsx(U,{value:R,onChange:s=>O(s.target.value),placeholder:"Enter your note..."})]})}),e.jsxs(K,{children:[e.jsx(n,{variant:"outline",onClick:()=>w(!1),children:"Cancel"}),e.jsxs(n,{onClick:()=>r&&L.mutate({id:r.id,note:R}),disabled:!R||L.isPending,children:[L.isPending?e.jsx(k,{className:"h-4 w-4 animate-spin mr-2"}):null,"Add Note"]})]})]})}),e.jsx(S,{open:te,onOpenChange:C,children:e.jsxs(D,{children:[e.jsxs(M,{children:[e.jsx(A,{children:"Adjust Commission Amount"}),e.jsxs(G,{children:["Current amount: ",r&&u(r.net_amount)]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(T,{children:"New Amount"}),e.jsx(J,{type:"number",step:"0.01",value:$,onChange:s=>q(s.target.value)})]}),e.jsxs("div",{children:[e.jsx(T,{children:"Reason for adjustment"}),e.jsx(U,{value:H,onChange:s=>V(s.target.value),placeholder:"Enter the reason..."})]})]}),e.jsxs(K,{children:[e.jsx(n,{variant:"outline",onClick:()=>C(!1),children:"Cancel"}),e.jsxs(n,{onClick:()=>r&&I.mutate({id:r.id,newAmount:parseFloat($),reason:H}),disabled:!$||!H||I.isPending,children:[I.isPending?e.jsx(k,{className:"h-4 w-4 animate-spin mr-2"}):null,"Save Adjustment"]})]})]})})]})}export{rs as default};
