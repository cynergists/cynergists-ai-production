import{c as Ee,r as c,q as Le,s as O,u as Re,j as e,n as ne,J as Ie,B as w,e as R,aF as te,X as We,Q as qe,C as ze,aO as Ue,as as He,H as Be,U as Ge,R as Qe,L as Xe,z as Ye}from"./app-C9sJHYCL.js";import{I as J}from"./input-BIyZmrfA.js";import{u as Je,S as Ze,a as Ke}from"./SaveViewDialog-dShgFaCa.js";import{u as et}from"./useAdminQueries-Ctam4DtW.js";import{f as tt}from"./phone-input-Dc2OHiOU.js";import{f as at}from"./errorMessages-9RXyVjba.js";import{C as P}from"./CenteredDash-Clgy4fR9.js";import{D as st,a as nt,c as rt,d as lt}from"./dialog-DAfnVAW3.js";import{T as it,a as ot,b as ke,c as ae,d as ct,e as se}from"./table-DvSgZRYl.js";import{C as pe}from"./credit-card-D5-dRmjT.js";import{R as dt}from"./receipt-Kn0ghxkp.js";import{S as ue,a as me,b as he,c as xe,d as Z}from"./select-Bb_vAbk5.js";import{A as ut,a as mt,b as ht,c as xt,d as pt,e as ft,f as gt,g as jt}from"./alert-dialog-Vkkmy3o4.js";import{G as vt}from"./grip-vertical-Df8dW_KB.js";import{C as bt}from"./check-BybgecC6.js";import{A as yt,a as Ct}from"./arrow-up-4JQI2Xh1.js";import{A as Nt}from"./arrow-down-Ci7eW4DK.js";import{L as X}from"./label-CON6LZW3.js";import{S as wt}from"./scroll-area-C84zghn6.js";import{R as St}from"./rotate-ccw-aRpJoVgy.js";import{V as _t,c as kt,a as Pt,U as Tt,S as At}from"./contact-D0Nzjq4O.js";import{C as Pe,a as Te}from"./card-xM_T_QEq.js";import{S as Dt,a as Mt,b as Ot,c as Et}from"./sheet-B5E0spRs.js";import{P as Ae,a as De,b as Me}from"./popover-BUA9TqoR.js";import{P as Lt,a as Wt,b as _e,c as $t,d as Ft,e as Vt}from"./pagination-BLV_ncXS.js";import{P as Rt}from"./plug-VLznMy7Z.js";import{L as It}from"./lightbulb-BDKXgUyf.js";import{E as qt}from"./eye-B3-dt3tC.js";import{F as zt}from"./filter-DdA--yCI.js";import{R as Oe}from"./refresh-cw-DieGtOyq.js";import{U as Ut}from"./user-plus-DaNWV7wY.js";/* empty css            */import"./checkbox-B_Z2dGVm.js";import"./index-C5ZtqSVZ.js";import"./index-H_9W4N8N.js";import"./useMutation-Dhp3buk0.js";import"./admin-api-CTwuhL-Q.js";import"./index-qTvOvuVq.js";import"./Combination-Bv4OtcuM.js";import"./index-BdQq_4o_.js";import"./index-mEKJzlVy.js";import"./chevron-up-CyWMtqZ2.js";import"./index-B3oBxWiH.js";import"./separator-CiQJM0oX.js";import"./index-Dx1E_Pz2.js";import"./star-AxoBUu9A.js";import"./eye-off-DqxFK8PI.js";import"./textarea-Ho9uOiBu.js";import"./switch-CgUnYb0N.js";import"./useAutoSave-HL8hQ_b2.js";import"./user-KPGr3U8Z.js";import"./phone-B-kOTN5P.js";import"./building-2-f0Ey5RTe.js";import"./target-BO60pVrf.js";import"./tag-C0gHXOnt.js";const Ht=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M16 14h.01",key:"1gbofw"}],["path",{d:"M8 18h.01",key:"lrp35t"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M16 18h.01",key:"kzsmim"}]],Bt=Ee("CalendarDays",Ht);const Gt=[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]],Qt=Ee("Map",Gt),Xt=["name","email","phone","status","payments","payment_type","last_payment_date","next_payment_due_date","payment_amount","sales_rep","partner_name","tags"];function Yt(){return Je({tableName:"client_view_preferences",defaultColumnOrder:Xt,defaultSortColumn:"name",defaultSortDirection:"asc"})}function $e(){const[t,o]=c.useState(!1),[r,i]=c.useState(!1),[v,b]=c.useState(null),{toast:f}=Le(),T=c.useCallback(async(C,j)=>{o(!0),b(null);try{const{data:{session:x}}=await O.auth.getSession();if(!x)return b("Not authenticated"),null;const{data:n,error:y}=await O.functions.invoke("update-client",{headers:{Authorization:`Bearer ${x.access_token}`},body:{clientId:C,updates:j}});if(y)throw new Error(y.message);if(n.error)throw new Error(n.error);return f({title:"Client updated",description:"Changes have been saved"}),n.client}catch(x){const n=x instanceof Error?x.message:"Failed to update client",y=at(n,"client");return b(y),f({title:"Error",description:y,variant:"destructive"}),null}finally{o(!1)}},[f]),u=c.useCallback(async C=>{i(!0),b(null);try{const{data:{session:j}}=await O.auth.getSession();if(!j)return b("Not authenticated"),!1;const{data:x,error:n}=await O.functions.invoke("delete-client",{headers:{Authorization:`Bearer ${j.access_token}`},body:{clientId:C}});if(n)throw new Error(n.message);if(x.error)throw new Error(x.error);return f({title:"Client deleted",description:"Client has been removed"}),!0}catch(j){const x=j instanceof Error?j.message:"Failed to delete client";return b(x),f({title:"Error",description:x,variant:"destructive"}),!1}finally{i(!1)}},[f]);return{updateClient:T,deleteClient:u,updating:t,deleting:r,error:v}}function Fe({isOpen:t,onClose:o,clientId:r,clientName:i,clientEmail:v,squareCustomerId:b}){const{data:f,isLoading:T}=Re({queryKey:["client-payments",r,b,v],queryFn:async()=>{const n=[];n.push(`client_id.eq.${r}`),b&&n.push(`square_customer_id.eq.${b}`);const{data:y,error:E}=await O.from("payments").select("*").or(n.join(",")).order("captured_at",{ascending:!1});if(E)throw console.error("Error fetching client payments:",E),E;let A=y||[];const S=new Set(A.map(g=>g.id));if(v){const{data:g}=await O.from("payments").select("*").order("captured_at",{ascending:!1});if(g){const D=g.filter(N=>{if(S.has(N.id))return!1;const B=N.raw_json?.buyer_email_address;return B&&B.toLowerCase()===v.toLowerCase()});A=[...A,...D]}}return A.sort((g,D)=>{const N=g.captured_at?new Date(g.captured_at).getTime():0;return(D.captured_at?new Date(D.captured_at).getTime():0)-N}),A},enabled:t}),u=(n,y="USD")=>new Intl.NumberFormat("en-US",{style:"currency",currency:y}).format(n),C=n=>n.status==="captured"?e.jsx(R,{className:"bg-green-100 text-green-800 hover:bg-green-100",children:"Captured"}):n.status==="refunded"?e.jsx(R,{variant:"destructive",children:"Refunded"}):n.status==="failed"?e.jsx(R,{variant:"destructive",children:"Failed"}):n.status==="partial_refund"?e.jsx(R,{className:"bg-yellow-100 text-yellow-800 hover:bg-yellow-100",children:"Partial Refund"}):e.jsx(R,{variant:"outline",children:n.status}),j=f?.filter(n=>n.status==="captured").reduce((n,y)=>n+y.amount,0)||0,x=f?.length||0;return e.jsx(st,{open:t,onOpenChange:n=>!n&&o(),children:e.jsxs(nt,{className:"max-w-4xl max-h-[80vh] overflow-hidden flex flex-col",children:[e.jsx(rt,{children:e.jsxs(lt,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5"}),"Payments for ",i]})}),e.jsx("div",{className:"flex-1 overflow-auto",children:T?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(ne,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):!f||f.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-muted-foreground",children:[e.jsx(dt,{className:"h-12 w-12 mb-4 opacity-50"}),e.jsx("p",{children:"No payments found for this client"}),e.jsx("p",{className:"text-sm",children:"Payments will appear here once synced from Square"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-6 mb-4 p-4 bg-muted/50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Payments"}),e.jsx("p",{className:"text-2xl font-bold",children:x})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Captured"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:u(j)})]})]}),e.jsx("div",{className:"border rounded-lg",children:e.jsxs(it,{children:[e.jsx(ot,{children:e.jsxs(ke,{children:[e.jsx(ae,{children:"Date"}),e.jsx(ae,{children:"Amount"}),e.jsx(ae,{children:"Status"}),e.jsx(ae,{children:"Refund"}),e.jsx(ae,{children:"Payment ID"})]})}),e.jsx(ct,{children:f.map(n=>e.jsxs(ke,{children:[e.jsx(se,{children:n.captured_at?Ie(new Date(n.captured_at),"MMM d, yyyy h:mm a"):e.jsx(P,{})}),e.jsx(se,{className:"font-medium",children:u(n.amount,n.currency)}),e.jsx(se,{children:C(n)}),e.jsx(se,{children:n.refund_amount?u(n.refund_amount,n.currency):e.jsx(P,{})}),e.jsxs(se,{className:"font-mono text-xs text-muted-foreground",children:[n.square_payment_id?.slice(0,12),"..."]})]},n.id))})]})})]})}),e.jsx("div",{className:"flex justify-end pt-4 border-t",children:e.jsx(w,{variant:"outline",onClick:o,children:"Close"})})]})})}const Jt=[{value:"active",label:"Active"},{value:"past_due",label:"Past Due"},{value:"terminated",label:"Terminated"},{value:"paused",label:"Paused"}],Zt=[{value:"subscription",label:"Subscription"},{value:"one_time",label:"One Time"},{value:"invoice",label:"Invoice"}],Y={name:{key:"name",label:"Name",sortable:!0,minWidth:120,defaultWidth:180,editable:!0,editType:"text"},email:{key:"email",label:"Email",sortable:!0,minWidth:150,defaultWidth:220,editable:!0,editType:"text"},phone:{key:"phone",label:"Phone",sortable:!0,minWidth:150,defaultWidth:180,editable:!0,editType:"text",render:t=>tt(t.phone)},status:{key:"status",label:"Status",sortable:!0,minWidth:80,defaultWidth:120,editable:!0,editType:"select",selectOptions:Jt,render:t=>{const o=t.status||"unknown",r=o==="active"?"default":o==="past_due"?"destructive":o==="terminated"?"secondary":"outline";return e.jsx(R,{variant:r,children:o})}},payment_type:{key:"payment_type",label:"Payment Type",sortable:!0,minWidth:100,defaultWidth:130,editable:!1,editType:"select",selectOptions:Zt,render:t=>t.payment_type||e.jsx(P,{})},last_activity:{key:"last_activity",label:"Last Activity",sortable:!0,minWidth:100,defaultWidth:130,editable:!0,editType:"date",render:t=>t.last_activity?te(t.last_activity):e.jsx(P,{})},last_contact:{key:"last_contact",label:"Last Contact",sortable:!0,minWidth:100,defaultWidth:130,editable:!0,editType:"date",render:t=>t.last_contact?te(t.last_contact):e.jsx(P,{})},next_meeting:{key:"next_meeting",label:"Next Meeting",sortable:!0,minWidth:100,defaultWidth:130,editable:!0,editType:"date",render:t=>t.next_meeting?te(t.next_meeting):e.jsx(P,{})},last_payment_date:{key:"last_payment_date",label:"Last Payment",sortable:!0,minWidth:100,defaultWidth:130,editable:!1,editType:"date",render:t=>t.last_payment_date?te(t.last_payment_date):e.jsx(P,{})},next_payment_due_date:{key:"next_payment_due_date",label:"Next Payment",sortable:!0,minWidth:120,defaultWidth:150,editable:!1,editType:"date",render:t=>t.next_payment_due_date?te(t.next_payment_due_date):e.jsx(P,{})},payment_amount:{key:"payment_amount",label:"Payment Amount",sortable:!0,minWidth:100,defaultWidth:140,editable:!1,editType:"number",render:t=>t.payment_amount?`$${t.payment_amount.toLocaleString()}`:e.jsx(P,{})},sales_rep:{key:"sales_rep",label:"Sales Rep",sortable:!0,minWidth:100,defaultWidth:130,editable:!0,editType:"text",render:t=>t.sales_rep||e.jsx(P,{})},partner_name:{key:"partner_name",label:"Partner",sortable:!0,minWidth:100,defaultWidth:130,editable:!0,editType:"text",render:t=>t.partner_name||e.jsx(P,{})},tags:{key:"tags",label:"Tags",sortable:!1,minWidth:120,defaultWidth:180,editable:!1,render:t=>!t.tags||t.tags.length===0?e.jsx(P,{}):e.jsxs("div",{className:"flex gap-1 flex-wrap",children:[t.tags.slice(0,3).map(o=>e.jsx(R,{variant:"outline",className:"text-xs",children:o},o)),t.tags.length>3&&e.jsxs(R,{variant:"outline",className:"text-xs",children:["+",t.tags.length-3]})]})},payments:{key:"payments",label:"Payments",sortable:!1,minWidth:80,defaultWidth:100,editable:!1,render:()=>null}};function Kt({clients:t,loading:o,columnOrder:r,hiddenColumns:i,columnWidths:v,sortColumn:b,sortDirection:f,onSort:T,onClientClick:u,onColumnResize:C,onColumnReorder:j,onClientUpdated:x}){const n=r.filter(s=>!i.includes(s)&&Y[s]),[y,E]=c.useState(null),[A,S]=c.useState({}),g=c.useRef(0),D=c.useRef(0),[N,L]=c.useState(null),[B,I]=c.useState(null),[G,q]=c.useState(null),[M,W]=c.useState(""),{updateClient:K,updating:$}=$e(),[fe,z]=c.useState(!1),[Q,U]=c.useState(null),[F,re]=c.useState(null),ee=s=>A[s]!==void 0?A[s]:v[s]||Y[s]?.defaultWidth||150,ge=c.useCallback((s,l)=>{s.preventDefault(),s.stopPropagation(),E(l),g.current=s.clientX,D.current=v[l]||Y[l]?.defaultWidth||150;const m=a=>{const d=a.clientX-g.current,p=Math.max(20,D.current+d);S(_=>({..._,[l]:p}))},h=a=>{const d=a.clientX-g.current,p=Math.max(20,D.current+d);C(l,p),S(_=>{const Se={..._};return delete Se[l],Se}),E(null),document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",h)};document.addEventListener("mousemove",m),document.addEventListener("mouseup",h)},[v,C]),je=c.useCallback((s,l)=>{L(l),s.dataTransfer.effectAllowed="move",s.dataTransfer.setData("text/plain",l)},[]),ve=c.useCallback((s,l)=>{s.preventDefault(),s.dataTransfer.dropEffect="move",N&&l!==N&&I(l)},[N]),H=c.useCallback(()=>{I(null)},[]),le=c.useCallback((s,l)=>{if(s.preventDefault(),!N||N===l){L(null),I(null);return}const m=[...r],h=m.indexOf(N),a=m.indexOf(l);h!==-1&&a!==-1&&(m.splice(h,1),m.splice(a,0,N),j(m)),L(null),I(null)},[N,r,j]),be=c.useCallback(()=>{L(null),I(null)},[]),ie=(s,l,m)=>{q({clientId:s,field:l}),W(m?.toString()||"")},oe=()=>{q(null),W("")},V=async(s,l)=>{if($)return;const m=Y[l];let h=M||null;m.editType==="number"&&M&&(h=parseFloat(M)),await K(s,{[l]:h})&&(q(null),W(""),x?.())},ye=(s,l,m)=>{s.key==="Enter"?(s.preventDefault(),V(l,m)):s.key==="Escape"&&oe()},Ce=async(s,l,m,h)=>{if($)return;if(l==="status"&&m==="terminated"){U({clientId:s,clientName:h||"this client"}),z(!0);return}await K(s,{[l]:m||null})&&(q(null),W(""),x?.())},Ne=async()=>{if(!Q||$)return;await K(Q.clientId,{status:"terminated"})&&(q(null),W(""),x?.()),z(!1),U(null)},ce=()=>{z(!1),U(null),q(null),W("")},we=({column:s})=>b!==s?e.jsx(yt,{className:"h-4 w-4 ml-1 opacity-50 flex-shrink-0"}):f==="asc"?e.jsx(Ct,{className:"h-4 w-4 ml-1 flex-shrink-0"}):e.jsx(Nt,{className:"h-4 w-4 ml-1 flex-shrink-0"});return o&&t.length===0?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(ne,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):!o&&t.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-muted-foreground",children:[e.jsx("p",{children:"No clients found"}),e.jsx("p",{className:"text-sm",children:"Try adjusting your search or filters"})]}):e.jsxs("div",{className:"relative",children:[o&&e.jsx("div",{className:"absolute inset-0 bg-background/50 flex items-center justify-center z-20",children:e.jsx(ne,{className:"h-6 w-6 animate-spin text-primary"})}),e.jsxs("table",{style:{tableLayout:"fixed",width:"max-content",minWidth:"100%"},className:"w-full caption-bottom text-sm",children:[e.jsx("thead",{className:"[&_tr]:border-b",children:e.jsx("tr",{className:"border-b transition-colors bg-background",children:n.map((s,l)=>{const m=Y[s],h=ee(s),a=N===s,d=B===s,p=l===0;return e.jsxs("th",{className:`h-12 px-4 text-left align-middle font-medium text-muted-foreground bg-background relative group transition-all sticky top-0 ${a?"opacity-50":""} ${d?"bg-primary/10 border-l-2 border-primary":""} ${p?"left-0 z-30 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]":"z-20"}`,style:{width:`${h}px`,minWidth:"20px"},draggable:!0,onDragStart:_=>je(_,s),onDragOver:_=>ve(_,s),onDragLeave:H,onDrop:_=>le(_,s),onDragEnd:be,children:[e.jsxs("div",{className:`flex items-start pr-3 ${m.sortable?"cursor-pointer select-none hover:text-foreground":""}`,onClick:()=>m.sortable&&T(s),children:[e.jsx(vt,{className:"h-4 w-4 mr-1 opacity-30 group-hover:opacity-70 cursor-grab flex-shrink-0 mt-0.5"}),e.jsx("span",{style:{wordBreak:"keep-all",overflowWrap:"normal",whiteSpace:"normal"},children:m.label}),m.sortable&&e.jsx(we,{column:s})]}),e.jsx("div",{className:`absolute right-0 top-0 h-full w-1 cursor-col-resize hover:bg-primary/50 transition-colors ${y===s?"bg-primary":"bg-transparent group-hover:bg-border"}`,onMouseDown:_=>ge(_,s)})]},s)})})}),e.jsx("tbody",{className:"[&_tr:last-child]:border-0",children:t.map(s=>e.jsx("tr",{className:"border-b transition-colors hover:bg-muted/50 align-top",children:n.map((l,m)=>{const h=Y[l],a=l==="name",d=ee(l),p=h.editable!==!1,_=G?.clientId===s.id&&G?.field===l,de=m===0?"sticky left-0 z-10 bg-background shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]":"";return _&&p?h.editType==="select"&&h.selectOptions?e.jsx("td",{className:`p-1 align-middle ${de}`,style:{width:`${d}px`,maxWidth:`${d}px`},children:e.jsxs(ue,{value:M,onValueChange:k=>Ce(s.id,l,k,s.name),children:[e.jsx(me,{className:"h-8",children:e.jsx(he,{placeholder:"Select..."})}),e.jsx(xe,{children:h.selectOptions.map(k=>e.jsx(Z,{value:k.value,children:k.label},k.value))})]})},l):e.jsx("td",{className:`p-1 align-middle ${de}`,style:{width:`${d}px`,maxWidth:`${d}px`},children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(J,{type:h.editType==="date"?"date":h.editType==="number"?"number":"text",value:M,onChange:k=>W(k.target.value),onKeyDown:k=>ye(k,s.id,l),onBlur:()=>V(s.id,l),autoFocus:!0,className:"h-8 text-sm",disabled:$}),e.jsx("button",{onClick:()=>V(s.id,l),className:"p-1 hover:bg-primary/10 rounded",disabled:$,children:e.jsx(bt,{className:"h-4 w-4 text-green-600"})}),e.jsx("button",{onClick:oe,className:"p-1 hover:bg-destructive/10 rounded",children:e.jsx(We,{className:"h-4 w-4 text-destructive"})})]})},l):l==="payments"?e.jsx("td",{className:`p-2 align-middle ${de}`,style:{width:`${d}px`,maxWidth:`${d}px`},children:e.jsx(w,{variant:"ghost",size:"sm",className:"h-8 px-2",onClick:k=>{k.stopPropagation(),re(s)},children:e.jsx(pe,{className:"h-4 w-4"})})},l):e.jsx("td",{onClick:k=>{if(a)u(s);else if(p){k.stopPropagation();const Ve=s[l];ie(s.id,l,Ve)}},className:`p-4 align-middle break-words align-top ${a?"font-medium text-primary hover:underline cursor-pointer":""} ${p&&!a?"cursor-pointer hover:bg-muted/80":""} ${de}`,style:{width:`${d}px`,maxWidth:`${d}px`,wordBreak:"break-word"},children:h.render?h.render(s):s[l]||e.jsx(P,{})},l)})},s.id))})]}),e.jsx(ut,{open:fe,onOpenChange:z,children:e.jsxs(mt,{children:[e.jsxs(ht,{children:[e.jsx(xt,{children:"Terminate Client?"}),e.jsxs(pt,{className:"space-y-2",children:[e.jsxs("p",{children:["Are you sure you want to terminate ",e.jsx("strong",{children:Q?.clientName}),"? This action will:"]}),e.jsxs("ul",{className:"list-disc list-inside space-y-1 text-sm",children:[e.jsx("li",{children:"Cancel their active subscription in Square"}),e.jsx("li",{children:"Stop all future automatic payments"}),e.jsx("li",{children:"Mark the client as terminated in the system"})]}),e.jsx("p",{className:"font-medium text-destructive",children:"This will immediately stop payments from being pulled from their bank or card."})]})]}),e.jsxs(ft,{children:[e.jsx(gt,{onClick:ce,children:"Cancel"}),e.jsx(jt,{onClick:Ne,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",disabled:$,children:$?"Terminating...":"Yes, Terminate Client"})]})]})}),F&&e.jsx(Fe,{isOpen:!!F,onClose:()=>re(null),clientId:F.id,clientName:F.name,clientEmail:F.email,squareCustomerId:F.square_customer_id})]})}const ea=[{value:"all",label:"All"},{value:"active",label:"Active"},{value:"past_due",label:"Past Due"},{value:"terminated",label:"Terminated"}],ta=[{value:"all",label:"All"},{value:"monthly",label:"Monthly"},{value:"annual",label:"Annual"},{value:"one-time",label:"One-Time"}];function aa({activeFilters:t,onFilterChange:o,onClearFilters:r}){return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"font-medium",children:"Filters"}),e.jsxs(w,{variant:"ghost",size:"sm",onClick:r,children:[e.jsx(St,{className:"h-3 w-3 mr-1"}),"Reset"]})]}),e.jsx(wt,{className:"h-[300px] pr-3",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{className:"text-xs",children:"Status"}),e.jsxs(ue,{value:t.status||"all",onValueChange:i=>o("status",i==="all"?"":i),children:[e.jsx(me,{children:e.jsx(he,{placeholder:"Select status"})}),e.jsx(xe,{children:ea.map(i=>e.jsx(Z,{value:i.value,children:i.label},i.value))})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{className:"text-xs",children:"Payment Type"}),e.jsxs(ue,{value:t.payment_type||"all",onValueChange:i=>o("payment_type",i==="all"?"":i),children:[e.jsx(me,{children:e.jsx(he,{placeholder:"Select type"})}),e.jsx(xe,{children:ta.map(i=>e.jsx(Z,{value:i.value,children:i.label},i.value))})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{className:"text-xs",children:"Company"}),e.jsx(J,{placeholder:"Filter by company...",value:t.company||"",onChange:i=>o("company",i.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{className:"text-xs",children:"Sales Rep"}),e.jsx(J,{placeholder:"Filter by sales rep...",value:t.sales_rep||"",onChange:i=>o("sales_rep",i.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{className:"text-xs",children:"Partner"}),e.jsx(J,{placeholder:"Filter by partner...",value:t.partner_name||"",onChange:i=>o("partner_name",i.target.value)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(X,{className:"text-xs",children:"Tag"}),e.jsx(J,{placeholder:"Filter by tag...",value:t.tags||"",onChange:i=>o("tags",i.target.value)})]})]})})]})}const sa={name:"Client Name",email:"Email",phone:"Phone",status:"Status",payment_type:"Payment Type",last_activity:"Last Activity",last_contact:"Last Contact",next_meeting:"Next Meeting",last_payment_date:"Last Payment",next_payment_due_date:"Next Payment",payment_amount:"Payment Amount",sales_rep:"Sales Rep",partner_name:"Partner",tags:"Tags"};function na(t){return e.jsx(_t,{...t,columnLabels:sa})}function ra({client:t,onClose:o,onUpdated:r}){const{updateClient:i,deleteClient:v,updating:b,deleting:f}=$e(),[T,u]=c.useState(!1),C=kt(t),j=c.useCallback(async n=>{const y=Pt(n);return await i(t.id,y)?(r(),!0):!1},[t.id,i,r]),x=c.useCallback(async()=>{const n=await v(t.id);return n&&(o(),r()),n},[t.id,v,o,r]);return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-4 mb-2",children:e.jsxs(w,{variant:"outline",className:"w-full",onClick:()=>u(!0),children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"View Payments"]})}),e.jsx(Tt,{contact:C,contactType:"client",onClose:o,onSave:j,onDelete:x,isCreating:!1,saving:b,deleting:f}),e.jsx(Fe,{isOpen:T,onClose:()=>u(!1),clientId:t.id,clientName:t.name,clientEmail:t.email,squareCustomerId:t.square_customer_id})]})}function la({summary:t,loading:o,hasActiveFilters:r}){const i=u=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(u),v=u=>Ue(u),b=(t?.activeMonthlyCount??0)+(t?.activeAnnualCount??0),f=(t?.totalActiveAmount??0)*12,T=[{label:"Active Accounts",dollarAmount:t?i(t.totalActiveAmount):"$0",annualAmount:i(f),showPerMonth:!0,rows:[{label:"Active Clients",value:b},{label:"Terminated",value:t?.terminatedTotalCount??0},{label:"Retention",value:v(t?.retentionTotalPercent??0)}],icon:qe,color:"text-emerald-600 dark:text-emerald-400",bgColor:"bg-emerald-50 dark:bg-emerald-950/30"},{label:"Monthly Subscriptions",dollarAmount:t?i(t.activeMonthlyAmount):"$0",annualAmount:i((t?.activeMonthlyAmount??0)*12),showPerMonth:!0,rows:[{label:"Active Clients",value:t?.activeMonthlyCount??0},{label:"Terminated",value:t?.terminatedMonthlyCount??0},{label:"Retention",value:v(t?.retentionMonthlyPercent??0)}],icon:ze,color:"text-blue-600 dark:text-blue-400",bgColor:"bg-blue-50 dark:bg-blue-950/30"},{label:"Annual Subscriptions",dollarAmount:t?i(t.activeAnnualAmount??0):"$0",annualAmount:i((t?.activeAnnualAmount??0)*12),showPerMonth:!0,rows:[{label:"Active Clients",value:t?.activeAnnualCount??0},{label:"Terminated",value:t?.terminatedAnnualCount??0},{label:"Retention",value:v(t?.retentionAnnualPercent??0)}],icon:Bt,color:"text-purple-600 dark:text-purple-400",bgColor:"bg-purple-50 dark:bg-purple-950/30"},{label:"One Time Payments",dollarAmount:t?i(t.activeOneTimeAmount):"$0",annualAmount:null,showPerMonth:!1,rows:[{label:"Clients",value:t?.activeOneTimeCount??0}],icon:pe,color:"text-amber-600 dark:text-amber-400",bgColor:"bg-amber-50 dark:bg-amber-950/30"}];return o?e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:T.map((u,C)=>e.jsx(Pe,{className:"border-border/50",children:e.jsxs(Te,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:u.label}),e.jsx("div",{className:`p-2 rounded-lg ${u.bgColor}`,children:e.jsx(u.icon,{className:`h-4 w-4 ${u.color}`})})]}),e.jsx(ne,{className:"h-6 w-6 animate-spin text-muted-foreground"})]})},C))}):e.jsxs("div",{className:"space-y-2",children:[r&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{variant:"secondary",className:"text-xs",children:"Filtered Results"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Metrics reflect your current filter selection"})]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:T.map((u,C)=>e.jsx(Pe,{className:"border-border/50",children:e.jsxs(Te,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:`p-2 rounded-lg ${u.bgColor}`,children:e.jsx(u.icon,{className:`h-4 w-4 ${u.color}`})}),e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:u.label})]}),e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("p",{className:"text-2xl font-bold text-foreground",children:[u.dollarAmount,u.showPerMonth&&e.jsx("span",{className:"text-sm font-normal text-muted-foreground",children:"/mo"})]}),u.annualAmount&&e.jsxs("p",{className:"text-lg font-semibold text-foreground",children:[u.annualAmount,e.jsx("span",{className:"text-xs font-normal text-muted-foreground",children:"/yr"})]})]}),e.jsx("div",{className:"space-y-1",children:u.rows.map((j,x)=>e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-muted-foreground",children:[j.label,":"]}),e.jsx("span",{className:"font-medium text-foreground",children:j.value})]},x))})]})},C))})]})}const ia=[{title:"Tenant Management",description:"Manage customer portal instances",icon:Ge,href:"/admin/client-portal/tenants",color:"text-primary"},{title:"Roadmap",description:"Configure roadmap items",icon:Qt,href:"/admin/client-portal/roadmap",color:"text-orange-500"},{title:"Integrations",description:"Set available integrations",icon:Rt,href:"/admin/client-portal/integrations",color:"text-purple-500"},{title:"FAQs",description:"Edit support FAQ content",icon:Qe,href:"/admin/client-portal/faqs",color:"text-green-500"},{title:"Suggestions",description:"Review agent ideas",icon:It,href:"/admin/client-portal/suggestions",color:"text-yellow-500"},{title:"Preview",description:"View as customer",icon:qt,href:"/portal",color:"text-cyan-500",external:!0}];function cs(){const t=He(),{toast:o}=Le(),{preferences:r,loading:i,setSort:v,setFilter:b,clearFilters:f,setRowsPerPage:T,setColumnOrder:u,setColumnWidth:C,toggleColumnVisibility:j,saveView:x,loadView:n,deleteView:y,setDefaultView:E,resetToDefault:A}=Yt(),[S,g]=c.useState(1),[D,N]=c.useState(""),[L,B]=c.useState(""),[I,G]=c.useState(null),[q,M]=c.useState(!1),[W,K]=c.useState(!1),[$,fe]=c.useState(!1),[z,Q]=c.useState(!1),[U,F]=c.useState(!1),[re,ee]=c.useState(!1),ge=async()=>{Q(!0);try{const{data:{session:a}}=await O.auth.getSession();if(!a){o({title:"Authentication required",description:"Please sign in to sync GHL data",variant:"destructive"});return}const{data:d,error:p}=await O.functions.invoke("sync-ghl-contacts",{headers:{Authorization:`Bearer ${a.access_token}`},body:{dryRun:!1}});if(p)throw p;if(d.error)throw new Error(d.error);o({title:"GHL Sync Complete",description:`Updated ${d.clientsUpdated} clients and ${d.prospectsUpdated} prospects.`}),t.invalidateQueries({queryKey:["admin","clients"]})}catch(a){console.error("GHL sync error:",a),o({title:"Sync Failed",description:a instanceof Error?a.message:"Failed to sync GHL data",variant:"destructive"})}finally{Q(!1)}},je=async()=>{F(!0);try{const{data:{session:a}}=await O.auth.getSession();if(!a){o({title:"Authentication required",description:"Please sign in to sync Square data",variant:"destructive"});return}const{data:d,error:p}=await O.functions.invoke("sync-square-clients",{headers:{Authorization:`Bearer ${a.access_token}`}});if(p)throw p;if(d.error)throw new Error(d.error);o({title:"Square Sync Complete",description:`Synced ${d.syncedCount} clients from Square.`}),t.invalidateQueries({queryKey:["admin","clients"]})}catch(a){console.error("Square sync error:",a),o({title:"Sync Failed",description:a instanceof Error?a.message:"Failed to sync Square data",variant:"destructive"})}finally{F(!1)}},ve=a=>{N(a);const d=setTimeout(()=>{B(a),g(1)},300);return()=>clearTimeout(d)},{data:H,isLoading:le}=et({page:S,limit:r.rowsPerPage,sortColumn:r.sortColumn,sortDirection:r.sortDirection,search:L,filters:r.activeFilters}),be=H?.clients||[],ie=H?.total||0,oe=H?.activeCount||0,V=H?.totalPages||0,ye=H?.summary||null,Ce=a=>{G(a),M(!0)},Ne=()=>{M(!1),G(null)},ce=async()=>{await t.refetchQueries({queryKey:["admin","clients"]})},we=a=>{const d=r.sortColumn===a&&r.sortDirection==="asc"?"desc":"asc";v(a,d),g(1)},s=(a,d)=>{b(a,d),g(1)},l=()=>{f(),g(1)},m=a=>{T(parseInt(a)),g(1)},h=Object.keys(r.activeFilters).length;return i?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(ne,{className:"h-8 w-8 animate-spin text-primary"})}):e.jsxs(e.Fragment,{children:[e.jsx(Be,{children:e.jsx("title",{children:"Client Portal | Admin"})}),e.jsxs("div",{className:"flex flex-col h-[calc(100vh-64px)] overflow-hidden",children:[e.jsxs("div",{className:"flex-shrink-0 p-6 pb-4 space-y-4 bg-background",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Client Portal"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Manage clients and configure portal content"})]})}),e.jsx("div",{className:"flex flex-wrap gap-2",children:ia.map(a=>e.jsx(Xe,{href:a.href,target:a.external?"_blank":void 0,rel:a.external?"noopener noreferrer":void 0,children:e.jsxs(w,{variant:"outline",size:"sm",className:"gap-2",children:[e.jsx(a.icon,{className:`h-4 w-4 ${a.color}`}),a.title]})},a.title))}),e.jsx(la,{summary:ye,loading:le,hasActiveFilters:h>0||L.length>0}),e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-foreground",children:"Clients"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[oe," Active Clients"]})]}),e.jsxs("div",{className:"flex items-center gap-1 border-l pl-6",children:[e.jsx(w,{variant:r.activeViewName===null?"secondary":"ghost",size:"sm",onClick:A,className:"text-sm",children:"All"}),r.savedViews.map(a=>e.jsx(w,{variant:r.activeViewName===a.name?"secondary":"ghost",size:"sm",onClick:()=>n(a.name),className:"text-sm",children:a.name},a.name)),r.savedViews.length<3&&e.jsxs(w,{variant:"ghost",size:"sm",onClick:()=>ee(!0),className:"text-sm text-muted-foreground",children:[e.jsx(Ze,{className:"h-3 w-3 mr-1"}),"Save View"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ye,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(J,{placeholder:"Search clients...",value:D,onChange:a=>ve(a.target.value),className:"pl-9 w-64"})]}),e.jsxs(Ae,{open:W,onOpenChange:K,children:[e.jsx(De,{asChild:!0,children:e.jsxs(w,{variant:"outline",className:"relative",children:[e.jsx(zt,{className:"h-4 w-4 mr-2"}),"Filters",h>0&&e.jsx("span",{className:"absolute -top-1 -right-1 h-5 w-5 rounded-full bg-primary text-primary-foreground text-xs flex items-center justify-center",children:h})]})}),e.jsx(Me,{className:"w-80",align:"end",children:e.jsx(aa,{activeFilters:r.activeFilters,onFilterChange:s,onClearFilters:l})})]}),e.jsxs(Ae,{open:$,onOpenChange:fe,children:[e.jsx(De,{asChild:!0,children:e.jsxs(w,{variant:"outline",children:[e.jsx(At,{className:"h-4 w-4 mr-2"}),"Columns"]})}),e.jsx(Me,{className:"w-80",align:"end",children:e.jsx(na,{columnOrder:r.columnOrder,hiddenColumns:r.hiddenColumns,savedViews:r.savedViews,activeViewName:r.activeViewName,defaultViewName:r.defaultViewName,onColumnOrderChange:u,onToggleColumn:j,onLoadView:n,onDeleteView:y,onSetDefaultView:E,onResetToDefault:A})})]}),e.jsxs(w,{variant:"outline",onClick:je,disabled:U,children:[e.jsx(Oe,{className:`h-4 w-4 mr-2 ${U?"animate-spin":""}`}),U?"Syncing...":"Sync Square"]}),e.jsxs(w,{variant:"outline",onClick:ge,disabled:z,children:[e.jsx(Oe,{className:`h-4 w-4 mr-2 ${z?"animate-spin":""}`}),z?"Syncing...":"Sync GHL"]}),e.jsxs(w,{onClick:()=>{G(null),M(!0)},children:[e.jsx(Ut,{className:"h-4 w-4 mr-2"}),"Add Client"]})]})]}),h>0&&e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Active filters:"}),Object.entries(r.activeFilters).map(([a,d])=>e.jsxs(w,{variant:"secondary",size:"sm",onClick:()=>s(a,""),className:"h-6 text-xs",children:[a,": ",d,e.jsx(We,{className:"h-3 w-3 ml-1"})]},a)),e.jsx(w,{variant:"ghost",size:"sm",onClick:l,className:"h-6 text-xs",children:"Clear all"})]})]}),e.jsx("div",{className:"flex-1 overflow-hidden px-6",children:e.jsx("div",{className:"border rounded-lg h-full overflow-auto",children:e.jsx(Kt,{clients:be,loading:le,columnOrder:r.columnOrder,hiddenColumns:r.hiddenColumns,columnWidths:r.columnWidths,sortColumn:r.sortColumn,sortDirection:r.sortDirection,onSort:we,onClientClick:Ce,onColumnResize:C,onColumnReorder:u,onClientUpdated:ce})})}),e.jsx("div",{className:"flex-shrink-0 px-6 py-4 bg-background border-t",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Rows per page:"}),e.jsxs(ue,{value:r.rowsPerPage.toString(),onValueChange:m,children:[e.jsx(me,{className:"w-20",children:e.jsx(he,{})}),e.jsxs(xe,{children:[e.jsx(Z,{value:"25",children:"25"}),e.jsx(Z,{value:"50",children:"50"}),e.jsx(Z,{value:"100",children:"100"})]})]}),e.jsxs("span",{className:"text-sm text-muted-foreground ml-4",children:["Showing ",(S-1)*r.rowsPerPage+1," - ",Math.min(S*r.rowsPerPage,ie)," of ",ie]})]}),V>1&&e.jsx(Lt,{children:e.jsxs(Wt,{children:[e.jsx(_e,{children:e.jsx($t,{onClick:()=>g(a=>Math.max(1,a-1)),className:S===1?"pointer-events-none opacity-50":"cursor-pointer"})}),Array.from({length:Math.min(5,V)},(a,d)=>{const p=S<=3?d+1:S+d-2;return p<1||p>V?null:e.jsx(_e,{children:e.jsx(Ft,{onClick:()=>g(p),isActive:S===p,className:"cursor-pointer",children:p})},p)}),e.jsx(_e,{children:e.jsx(Vt,{onClick:()=>g(a=>Math.min(V,a+1)),className:S===V?"pointer-events-none opacity-50":"cursor-pointer"})})]})})]})})]}),e.jsx(Dt,{open:q,onOpenChange:M,children:e.jsxs(Mt,{className:"w-full sm:max-w-xl overflow-y-auto",children:[e.jsx(Ot,{children:e.jsx(Et,{children:"Client Details"})}),I&&e.jsx(ra,{client:I,onClose:Ne,onUpdated:ce})]})}),e.jsx(Ke,{open:re,onOpenChange:ee,onSave:x,existingViewNames:r.savedViews.map(a=>a.name)})]})}export{cs as default};
