import{c as W,ba as U,r as o,s as p,h as m,j as e,p as X,B as u,P as Z,m as w,C as ee,K as j,e as I,bc as se}from"./app-C0WycfZe.js";import{C as x,b as re,c as ae,d as te,a as N}from"./card-Bi-8_L45.js";import{D as le,g as ie,a as ne,c as ce,d as de,e as oe}from"./dialog-BrdWhXwW.js";import{L as h}from"./label-BqY6sEFX.js";import{I as he}from"./input-B1mdCLd5.js";import{S as y,a as f,b as _,c as g,d as i}from"./select-DQRCPwkF.js";import{C as V}from"./checkbox-jLyXXTBW.js";import{T as O,a as q,b,c as n,d as z,e as c}from"./table-D6JhU9yR.js";import{T as me,a as xe,b as A,c as B}from"./tabs-CfnvAjFb.js";import{P as ue}from"./play-CeJlZ6_Z.js";import{D as H}from"./download-2YQvy6Wk.js";/* empty css            */import"./index-Cch_8Clv.js";import"./Combination-COh087cd.js";import"./index-B-RSaXN7.js";import"./index-BdQq_4o_.js";import"./index-CQc07GE5.js";import"./index-CuknWpgH.js";import"./check-43nAdBq2.js";import"./chevron-up-DGGjGr1B.js";import"./index-cEAPOc8E.js";import"./index-BYG5vXjd.js";const pe=[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"6",ry:"6",key:"f2vt7d"}],["circle",{cx:"8",cy:"12",r:"2",key:"1nvbw3"}]],je=W("ToggleLeft",pe);const ye=[["rect",{width:"20",height:"12",x:"2",y:"6",rx:"6",ry:"6",key:"f2vt7d"}],["circle",{cx:"16",cy:"12",r:"2",key:"4ma0v8"}]],fe=W("ToggleRight",ye),_e=["","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];function He(){const{status:C,partner:l}=U(),[D,Y]=o.useState([]),[k,G]=o.useState([]),[T,S]=o.useState(!0),[R,M]=o.useState(!1),[L,P]=o.useState(null),[K,E]=o.useState(!1),[r,d]=o.useState({schedule_type:"monthly",report_type:"combined",format_pdf:!0,format_csv:!0,day_of_week:1,day_of_month:1,detail_level:"detailed",email_to:""});o.useEffect(()=>{l?.id&&C==="active"?v():S(!1)},[l?.id,C]);const v=async()=>{if(l?.id){S(!0);try{const[s,a]=await Promise.all([p.from("partner_scheduled_reports").select("*").eq("partner_id",l.id).order("created_at",{ascending:!1}),p.from("report_runs").select("*").eq("partner_id",l.id).order("generated_at",{ascending:!1}).limit(20)]);if(s.error)throw s.error;if(a.error)throw a.error;Y(s.data||[]),G(a.data||[])}catch(s){console.error("Error fetching reports data:",s),m.error("Failed to load reports")}finally{S(!1)}}},Q=async()=>{if(l?.id){M(!0);try{const s=new Date;s.setDate(s.getDate()+7);const{error:a}=await p.from("partner_scheduled_reports").insert({partner_id:l.id,schedule_type:r.schedule_type,report_type:r.report_type,format_pdf:r.format_pdf,format_csv:r.format_csv,day_of_week:["weekly","biweekly"].includes(r.schedule_type)?r.day_of_week:null,day_of_month:["monthly","quarterly"].includes(r.schedule_type)?r.day_of_month:null,detail_level:r.detail_level,email_to:r.email_to||l.email,is_active:!0,next_run_at:s.toISOString()});if(a)throw a;m.success("Report schedule created"),E(!1),v()}catch(s){console.error("Error creating schedule:",s),m.error("Failed to create schedule")}finally{M(!1)}}},$=async(s,a)=>{try{const{error:t}=await p.from("partner_scheduled_reports").update({is_active:!a}).eq("id",s);if(t)throw t;m.success(a?"Schedule disabled":"Schedule enabled"),v()}catch(t){console.error("Error toggling schedule:",t),m.error("Failed to update schedule")}},J=async s=>{if(l?.id){P(s.id);try{const a=new Date,t=new Date;switch(s.schedule_type){case"weekly":t.setDate(t.getDate()-7);break;case"biweekly":t.setDate(t.getDate()-14);break;case"monthly":t.setDate(t.getDate()-30);break;case"quarterly":t.setDate(t.getDate()-90);break}const{data:ge,error:F}=await p.functions.invoke("generate-partner-report",{body:{report_id:s.id,partner_id:l.id,period_start:t.toISOString(),period_end:a.toISOString(),report_type:s.report_type,format_pdf:s.format_pdf,format_csv:s.format_csv,detail_level:s.detail_level,email_to:s.email_to||l.email}});if(F)throw F;m.success("Report generated and sent to your email"),v()}catch(a){console.error("Error running report:",a),m.error("Failed to generate report")}finally{P(null)}}};return C!=="active"?e.jsx("div",{className:"p-6 flex items-center justify-center min-h-[60vh]",children:e.jsx(x,{className:"max-w-md text-center",children:e.jsxs(re,{children:[e.jsx("div",{className:"mx-auto h-12 w-12 rounded-full bg-muted flex items-center justify-center mb-4",children:e.jsx(X,{className:"h-6 w-6 text-muted-foreground"})}),e.jsx(ae,{children:"Reports Locked"}),e.jsx(te,{children:"Report scheduling is available for active partners only."})]})})}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Reports"}),e.jsx("p",{className:"text-muted-foreground",children:"Schedule and download commission reports."})]}),e.jsxs(le,{open:K,onOpenChange:E,children:[e.jsx(ie,{asChild:!0,children:e.jsxs(u,{children:[e.jsx(Z,{className:"h-4 w-4 mr-2"})," New Schedule"]})}),e.jsxs(ne,{children:[e.jsxs(ce,{children:[e.jsx(de,{children:"Create Report Schedule"}),e.jsx(oe,{children:"Set up automated commission and payout reports."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Cadence"}),e.jsxs(y,{value:r.schedule_type,onValueChange:s=>d({...r,schedule_type:s}),children:[e.jsx(f,{children:e.jsx(_,{})}),e.jsxs(g,{children:[e.jsx(i,{value:"weekly",children:"Weekly"}),e.jsx(i,{value:"biweekly",children:"Biweekly"}),e.jsx(i,{value:"monthly",children:"Monthly"}),e.jsx(i,{value:"quarterly",children:"Quarterly"})]})]})]}),["weekly","biweekly"].includes(r.schedule_type)&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Day of Week"}),e.jsxs(y,{value:String(r.day_of_week),onValueChange:s=>d({...r,day_of_week:parseInt(s)}),children:[e.jsx(f,{children:e.jsx(_,{})}),e.jsx(g,{children:[1,2,3,4,5,6,7].map(s=>e.jsx(i,{value:String(s),children:_e[s]},s))})]})]}),["monthly","quarterly"].includes(r.schedule_type)&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Day of Month"}),e.jsxs(y,{value:String(r.day_of_month),onValueChange:s=>d({...r,day_of_month:parseInt(s)}),children:[e.jsx(f,{children:e.jsx(_,{})}),e.jsx(g,{children:Array.from({length:28},(s,a)=>a+1).map(s=>e.jsx(i,{value:String(s),children:s},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Report Type"}),e.jsxs(y,{value:r.report_type,onValueChange:s=>d({...r,report_type:s}),children:[e.jsx(f,{children:e.jsx(_,{})}),e.jsxs(g,{children:[e.jsx(i,{value:"combined",children:"Combined (Commissions + Payouts)"}),e.jsx(i,{value:"commissions",children:"Commissions Only"}),e.jsx(i,{value:"payouts",children:"Payouts Only"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Detail Level"}),e.jsxs(y,{value:r.detail_level,onValueChange:s=>d({...r,detail_level:s}),children:[e.jsx(f,{children:e.jsx(_,{})}),e.jsxs(g,{children:[e.jsx(i,{value:"detailed",children:"Detailed (with tables)"}),e.jsx(i,{value:"summary",children:"Summary only"})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(V,{id:"pdf",checked:r.format_pdf,onCheckedChange:s=>d({...r,format_pdf:!!s})}),e.jsx(h,{htmlFor:"pdf",children:"PDF"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(V,{id:"csv",checked:r.format_csv,onCheckedChange:s=>d({...r,format_csv:!!s})}),e.jsx(h,{htmlFor:"csv",children:"CSV"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Email To (optional)"}),e.jsx(he,{placeholder:l?.email||"Your email",value:r.email_to,onChange:s=>d({...r,email_to:s.target.value})})]}),e.jsxs(u,{className:"w-full",onClick:Q,disabled:R,children:[R&&e.jsx(w,{className:"h-4 w-4 mr-2 animate-spin"}),"Create Schedule"]})]})]})]})]}),e.jsxs(me,{defaultValue:"schedules",children:[e.jsxs(xe,{children:[e.jsx(A,{value:"schedules",children:"Schedules"}),e.jsx(A,{value:"history",children:"Report History"})]}),e.jsx(B,{value:"schedules",className:"mt-4",children:T?e.jsx(x,{children:e.jsx(N,{className:"py-12 text-center",children:e.jsx(w,{className:"h-8 w-8 animate-spin mx-auto text-muted-foreground"})})}):D.length===0?e.jsx(x,{children:e.jsxs(N,{className:"py-12 text-center",children:[e.jsx(ee,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"No report schedules yet. Create one to get started."})]})}):e.jsx(x,{children:e.jsxs(O,{children:[e.jsx(q,{children:e.jsxs(b,{children:[e.jsx(n,{children:"Cadence"}),e.jsx(n,{children:"Type"}),e.jsx(n,{children:"Next Run"}),e.jsx(n,{children:"Last Run"}),e.jsx(n,{children:"Status"}),e.jsx(n,{children:"Actions"})]})}),e.jsx(z,{children:D.map(s=>e.jsxs(b,{children:[e.jsx(c,{className:"capitalize",children:s.schedule_type}),e.jsx(c,{className:"capitalize",children:s.report_type}),e.jsx(c,{children:j(new Date(s.next_run_at),"MMM d, yyyy")}),e.jsx(c,{children:s.last_run_at?j(new Date(s.last_run_at),"MMM d, yyyy"):"-"}),e.jsx(c,{children:e.jsx(I,{variant:s.is_active?"default":"secondary",children:s.is_active?"Active":"Disabled"})}),e.jsx(c,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(u,{size:"sm",variant:"outline",onClick:()=>J(s),disabled:L===s.id,children:L===s.id?e.jsx(w,{className:"h-4 w-4 animate-spin"}):e.jsx(ue,{className:"h-4 w-4"})}),e.jsx(u,{size:"sm",variant:"ghost",onClick:()=>$(s.id,s.is_active),children:s.is_active?e.jsx(fe,{className:"h-4 w-4"}):e.jsx(je,{className:"h-4 w-4"})})]})})]},s.id))})]})})}),e.jsx(B,{value:"history",className:"mt-4",children:T?e.jsx(x,{children:e.jsx(N,{className:"py-12 text-center",children:e.jsx(w,{className:"h-8 w-8 animate-spin mx-auto text-muted-foreground"})})}):k.length===0?e.jsx(x,{children:e.jsxs(N,{className:"py-12 text-center",children:[e.jsx(se,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"No reports generated yet."})]})}):e.jsx(x,{children:e.jsxs(O,{children:[e.jsx(q,{children:e.jsxs(b,{children:[e.jsx(n,{children:"Generated"}),e.jsx(n,{children:"Period"}),e.jsx(n,{children:"Status"}),e.jsx(n,{children:"Downloads"})]})}),e.jsx(z,{children:k.map(s=>e.jsxs(b,{children:[e.jsx(c,{children:j(new Date(s.generated_at),"MMM d, yyyy h:mm a")}),e.jsxs(c,{children:[j(new Date(s.period_start),"MMM d")," - ",j(new Date(s.period_end),"MMM d, yyyy")]}),e.jsx(c,{children:e.jsx(I,{variant:s.status==="emailed"?"default":s.status==="failed"?"destructive":"secondary",children:s.status})}),e.jsx(c,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[s.pdf_url&&e.jsx(u,{size:"sm",variant:"outline",asChild:!0,children:e.jsxs("a",{href:s.pdf_url,target:"_blank",rel:"noopener",children:[e.jsx(H,{className:"h-4 w-4 mr-1"})," PDF"]})}),s.csv_commissions_url&&e.jsx(u,{size:"sm",variant:"outline",asChild:!0,children:e.jsxs("a",{href:s.csv_commissions_url,target:"_blank",rel:"noopener",children:[e.jsx(H,{className:"h-4 w-4 mr-1"})," CSV"]})})]})})]},s.id))})]})})})]})]})}export{He as default};
