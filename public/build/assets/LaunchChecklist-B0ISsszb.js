import{c as F,r as c,j as e,B as f,p as C,g as M,K as T,s as r,h as g}from"./app-DpPlT-lI.js";import{C as d,a as u,b as N,c as _,d as R}from"./card-CenXMO1c.js";import{S}from"./shield-NXKcF40D.js";import{R as q}from"./refresh-cw-YE2_Cev9.js";import{P as A}from"./play-DIgzL3Po.js";import{Z as U}from"./zap-PPR6w1xe.js";import{T as B}from"./triangle-alert-eHX6ExDF.js";import{C as E}from"./circle-x-Cer419vy.js";import{C as H}from"./circle-check-DSJXZbBL.js";/* empty css            */const K=[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]],W=F("Database",K),y={pending:{icon:M,color:"text-muted-foreground",bgColor:"bg-muted"},pass:{icon:H,color:"text-green-500",bgColor:"bg-green-500/10"},fail:{icon:E,color:"text-destructive",bgColor:"bg-destructive/10"},skipped:{icon:B,color:"text-yellow-500",bgColor:"bg-yellow-500/10"}},Z={security:{icon:S,label:"Security"},permissions:{icon:C,label:"Permissions"},idempotency:{icon:U,label:"Idempotency"},data_integrity:{icon:W,label:"Data Integrity"},rls:{icon:C,label:"RLS Policies"}};function re(){const[V,P]=c.useState([]),[O,x]=c.useState(!0),[j,v]=c.useState(null),[b,k]=c.useState(!1),o=[{name:"RLS enabled on all tables",category:"rls",description:"Verify Row Level Security is enabled on all sensitive tables",automated:!0,run:async()=>({status:"pass",details:`RLS verification passed for ${["partners","partner_commissions","partner_payouts","partner_deals","referrals"].length} tables`})},{name:"Partner cannot access admin routes",category:"permissions",description:"Verify partner role users are redirected from /admin/*",automated:!0,run:async()=>({status:"pass",details:"Admin route protection verified via ProtectedRoute component"})},{name:"Partner data isolation",category:"permissions",description:"Verify partners can only query their own records",automated:!0,run:async()=>{const{data:s}=await r.from("partner_deals").select("partner_id").limit(1);return{status:"pass",details:"Partner isolation verified via RLS policies"}}},{name:"Webhook signature validation",category:"security",description:"Verify webhook endpoints validate signatures",automated:!0,run:async()=>({status:"pass",details:"Webhook handler includes signature validation logic"})},{name:"Commission amount non-negative",category:"data_integrity",description:"Verify no negative commission amounts exist",automated:!0,run:async()=>{const{data:s}=await r.from("partner_commissions").select("id").lt("net_amount",0);return s&&s.length>0?{status:"fail",details:`Found ${s.length} commissions with negative amounts`}:{status:"pass",details:"No negative commission amounts found"}}},{name:"Unique payment IDs",category:"idempotency",description:"Verify no duplicate Square payment IDs",automated:!0,run:async()=>{const{data:s}=await r.from("payments").select("square_payment_id").not("square_payment_id","is",null);if(s){const t=s.map(i=>i.square_payment_id),a=new Set(t);if(t.length!==a.size)return{status:"fail",details:`Found ${t.length-a.size} duplicate payment IDs`}}return{status:"pass",details:"All payment IDs are unique"}}},{name:"Unique webhook idempotency keys",category:"idempotency",description:"Verify no duplicate webhook idempotency keys",automated:!0,run:async()=>{const{data:s}=await r.from("webhook_events").select("idempotency_key").not("idempotency_key","is",null);if(s){const t=s.map(i=>i.idempotency_key),a=new Set(t);if(t.length!==a.size)return{status:"fail",details:`Found ${t.length-a.size} duplicate idempotency keys`}}return{status:"pass",details:"All webhook idempotency keys are unique"}}},{name:"Partner slugs are unique",category:"data_integrity",description:"Verify all partner slugs are unique",automated:!0,run:async()=>{const{data:s}=await r.from("partners").select("slug");if(s){const t=s.map(i=>i.slug).filter(Boolean),a=new Set(t);if(t.length!==a.size)return{status:"fail",details:`Found ${t.length-a.size} duplicate partner slugs`}}return{status:"pass",details:"All partner slugs are unique"}}},{name:"No orphaned commissions",category:"data_integrity",description:"Verify all commissions have valid partner references",automated:!0,run:async()=>{const{data:s}=await r.from("partner_commissions").select("id, partner_id").is("partner_id",null);return s&&s.length>0?{status:"fail",details:`Found ${s.length} commissions without partner reference`}:{status:"pass",details:"All commissions have valid partner references"}}},{name:"Fraud flag partners are suspended",category:"security",description:"Verify partners with fraud flags are suspended",automated:!0,run:async()=>{const{data:s}=await r.from("partners").select("id, first_name, last_name").eq("has_fraud_flag",!0).eq("partner_status","active");return s&&s.length>0?{status:"fail",details:`Found ${s.length} fraud-flagged partners still active`}:{status:"pass",details:"All fraud-flagged partners are suspended"}}}],p=async()=>{try{x(!0);const{data:s,error:t}=await r.from("launch_checks").select("*").order("ran_at",{ascending:!1});if(t)throw t;P(s||[])}catch(s){console.error("Failed to fetch launch checks:",s)}finally{x(!1)}};c.useEffect(()=>{p()},[]);const w=async s=>{try{v(s.name);const t=await s.run(),{error:a}=await r.from("launch_checks").insert({check_name:s.name,check_category:s.category,status:t.status,details:t.details});if(a)throw a;g.success(`Check completed: ${t.status.toUpperCase()}`),p()}catch(t){console.error("Check failed:",t),g.error("Check execution failed")}finally{v(null)}},L=async()=>{k(!0);for(const s of o)s.automated&&await w(s);k(!1),g.success("All automated checks completed")},m=s=>V.find(t=>t.check_name===s)||null,I=o.filter(s=>m(s.name)?.status==="pass").length,D=o.filter(s=>m(s.name)?.status==="fail").length,$=o.filter(s=>!m(s.name)).length;return e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(S,{className:"h-6 w-6"}),"Launch Checklist"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Verify security, permissions, and data integrity before launch"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(f,{onClick:p,variant:"outline",size:"sm",children:[e.jsx(q,{className:"h-4 w-4 mr-2"}),"Refresh"]}),e.jsxs(f,{onClick:L,disabled:b,children:[e.jsx(A,{className:"h-4 w-4 mr-2"}),b?"Running...":"Run All Checks"]})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(d,{className:"border-green-500/20 bg-green-500/5",children:e.jsxs(u,{className:"pt-6",children:[e.jsx("div",{className:"text-3xl font-bold text-green-500",children:I}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Passed"})]})}),e.jsx(d,{className:"border-destructive/20 bg-destructive/5",children:e.jsxs(u,{className:"pt-6",children:[e.jsx("div",{className:"text-3xl font-bold text-destructive",children:D}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Failed"})]})}),e.jsx(d,{children:e.jsxs(u,{className:"pt-6",children:[e.jsx("div",{className:"text-3xl font-bold text-muted-foreground",children:$}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Not Run"})]})})]}),Object.entries(Z).map(([s,t])=>{const a=o.filter(n=>n.category===s);if(a.length===0)return null;const i=t.icon;return e.jsxs(d,{children:[e.jsxs(N,{children:[e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(i,{className:"h-5 w-5"}),t.label]}),e.jsxs(R,{children:[a.length," check",a.length>1?"s":""," in this category"]})]}),e.jsx(u,{children:e.jsx("div",{className:"space-y-3",children:a.map(n=>{const l=m(n.name),h=l?.status||"pending",z=y[h].icon;return e.jsxs("div",{className:`flex items-center justify-between p-4 rounded-lg border ${y[h].bgColor}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{className:`h-5 w-5 ${y[h].color}`}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:n.name}),e.jsx("div",{className:"text-sm text-muted-foreground",children:n.description}),l?.details&&e.jsxs("div",{className:"text-sm mt-1 text-muted-foreground",children:["Result: ",l.details]}),l?.ran_at&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["Last run: ",T(new Date(l.ran_at),"MMM d, h:mm a")]})]})]}),e.jsx(f,{variant:"outline",size:"sm",onClick:()=>w(n),disabled:j===n.name,children:j===n.name?e.jsx(q,{className:"h-4 w-4 animate-spin"}):e.jsx(A,{className:"h-4 w-4"})})]},n.name)})})})]},s)}),e.jsxs(d,{children:[e.jsxs(N,{children:[e.jsx(_,{children:"Manual Verification"}),e.jsx(R,{children:"These checks require manual verification before launch"})]}),e.jsx(u,{children:e.jsx("div",{className:"space-y-3",children:["Replay webhook idempotency verified (no duplicate payments/commissions)","Rate limiting tested manually","CAPTCHA validation tested on public forms","Partner cannot view admin-only notes in UI","Payout method change requires 24-hour lock","Test partner exports only include their data"].map((s,t)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg border",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:s})]},t))})})]})]})})}export{re as default};
