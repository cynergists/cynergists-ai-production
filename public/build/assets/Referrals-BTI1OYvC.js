import{r as t,j as e,I as te,n as R,N as le,B as i,g as m,l as P,s as c,k as x}from"./app-CjsYDFmT.js";import{C as re,b as ne,a as ie}from"./card-Dz0yCaqc.js";import{I as de}from"./input-BBc2sdOt.js";import{S as D,a as A,b as k,c as L,d as l}from"./select-BZPifpxC.js";import{T as ce,a as oe,b as T,c as n,d as me,e as r}from"./table-eclqq7yM.js";import{D as z,a as M,c as V,d as Q,f as U}from"./dialog-vfH9N2qe.js";import{T as xe}from"./textarea-DjNE0yWa.js";import{L as pe}from"./label-Dvt0WIie.js";import{C as he}from"./copy-BKS4uOiM.js";import{T as ue}from"./triangle-alert-CdOhDIXa.js";import{E as H}from"./external-link-CIEI5SAF.js";import{C as je}from"./circle-check-big-qtUhGHvy.js";import{C as fe}from"./circle-x-DMjGwAh4.js";/* empty css            */import"./index-BdQq_4o_.js";import"./index-G0k2b-8C.js";import"./Combination-Mg1W9W58.js";import"./index-BSKaJvun.js";import"./check-BI7rB0RY.js";import"./chevron-up-CP4nq72x.js";import"./index-58Jk2LJy.js";import"./index-CSw9D2VK.js";const w={new:{label:"New",variant:"default"},accepted:{label:"Accepted",variant:"secondary"},qualified:{label:"Qualified",variant:"secondary"},converted:{label:"Converted",variant:"default"},rejected:{label:"Rejected",variant:"destructive"}};function ze(){const[$,X]=t.useState([]),[G,E]=t.useState(!0),[o,J]=t.useState(""),[y,K]=t.useState("all"),[j,W]=t.useState("all"),[f,Y]=t.useState("all"),[s,F]=t.useState(null),[Z,v]=t.useState(!1),[ee,p]=t.useState(!1),[h,g]=t.useState(!1),[u,C]=t.useState(""),b=async()=>{E(!0);try{const{data:a,error:d}=await c.from("referrals").select("*, partners(first_name, last_name, slug)").order("created_at",{ascending:!1});if(d)throw d;X(a||[])}catch(a){console.error("Error fetching referrals:",a),x.error("Failed to load referrals")}finally{E(!1)}};t.useEffect(()=>{b()},[]);const I=$.filter(a=>{const d=!o||a.lead_email?.toLowerCase().includes(o.toLowerCase())||a.lead_name?.toLowerCase().includes(o.toLowerCase())||a.lead_phone?.toLowerCase().includes(o.toLowerCase())||a.lead_company?.toLowerCase().includes(o.toLowerCase())||a.partners?.slug?.toLowerCase().includes(o.toLowerCase()),S=y==="all"||a.status===y,_=j==="all"||j==="yes"&&a.needs_approval||j==="no"&&!a.needs_approval,N=f==="all"||f==="yes"&&a.duplicate||f==="no"&&!a.duplicate;return d&&S&&_&&N}),O=async a=>{g(!0);try{const{error:d}=await c.from("referrals").update({status:"accepted",needs_approval:!1}).eq("id",a.id);if(d)throw d;if(a.deal_id)await c.from("partner_deals").update({partner_id:a.partner_id,last_activity_at:new Date().toISOString()}).eq("id",a.deal_id),await c.rpc("add_deal_note",{p_deal_id:a.deal_id,p_note_text:"Referral accepted by admin",p_note_type:"system"});else{const S=[a.first_name,a.last_name].filter(Boolean).join(" ")||a.lead_name||"Unknown",{data:_,error:N}=await c.from("partner_deals").insert({partner_id:a.partner_id,client_name:S,client_email:a.lead_email,client_phone:a.lead_phone,client_company:a.lead_company,stage:"new",deal_value:0,referral_id:a.id,timeline:[{timestamp:new Date().toISOString(),type:"created",message:"Deal created from accepted referral"}]}).select().single();if(N)throw N;await c.from("referrals").update({deal_id:_.id}).eq("id",a.id),await c.rpc("add_deal_note",{p_deal_id:_.id,p_note_text:"Deal created from accepted referral",p_note_type:"system"})}x.success("Referral accepted"),b(),v(!1)}catch(d){console.error("Error accepting referral:",d),x.error("Failed to accept referral")}finally{g(!1)}},ae=async()=>{if(!s||!u.trim()){x.error("Please provide a rejection reason");return}g(!0);try{const{error:a}=await c.from("referrals").update({status:"rejected",needs_approval:!1,rejection_reason:u.trim()}).eq("id",s.id);if(a)throw a;s.deal_id&&await c.rpc("add_deal_note",{p_deal_id:s.deal_id,p_note_text:`Referral rejected by admin: ${u.trim()}`,p_note_type:"admin"}),x.success("Referral rejected"),b(),p(!1),v(!1),C("")}catch(a){console.error("Error rejecting referral:",a),x.error("Failed to reject referral")}finally{g(!1)}},B=a=>a.partners?[a.partners.first_name,a.partners.last_name].filter(Boolean).join(" ")||a.partners.slug:"Unknown",q=a=>[a.first_name,a.last_name].filter(Boolean).join(" ")||a.lead_name||"N/A",se=a=>{navigator.clipboard.writeText(a),x.success("Copied to clipboard")};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex justify-between items-center",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Referrals Queue"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage partner referrals and link to deals"})]})}),e.jsxs(re,{children:[e.jsx(ne,{children:e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(te,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(de,{placeholder:"Search by email, name, phone, company, or partner...",value:o,onChange:a=>J(a.target.value),className:"pl-10"})]}),e.jsxs("div",{className:"flex gap-2 flex-wrap",children:[e.jsxs(D,{value:y,onValueChange:K,children:[e.jsx(A,{className:"w-[130px]",children:e.jsx(k,{placeholder:"Status"})}),e.jsxs(L,{children:[e.jsx(l,{value:"all",children:"All Status"}),e.jsx(l,{value:"new",children:"New"}),e.jsx(l,{value:"accepted",children:"Accepted"}),e.jsx(l,{value:"qualified",children:"Qualified"}),e.jsx(l,{value:"converted",children:"Converted"}),e.jsx(l,{value:"rejected",children:"Rejected"})]})]}),e.jsxs(D,{value:j,onValueChange:W,children:[e.jsx(A,{className:"w-[150px]",children:e.jsx(k,{placeholder:"Needs Approval"})}),e.jsxs(L,{children:[e.jsx(l,{value:"all",children:"All"}),e.jsx(l,{value:"yes",children:"Needs Approval"}),e.jsx(l,{value:"no",children:"No Approval Needed"})]})]}),e.jsxs(D,{value:f,onValueChange:Y,children:[e.jsx(A,{className:"w-[130px]",children:e.jsx(k,{placeholder:"Duplicates"})}),e.jsxs(L,{children:[e.jsx(l,{value:"all",children:"All"}),e.jsx(l,{value:"yes",children:"Duplicates"}),e.jsx(l,{value:"no",children:"Unique Only"})]})]})]})]})}),e.jsx(ie,{children:G?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(R,{className:"h-6 w-6 animate-spin"})}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(ce,{children:[e.jsx(oe,{children:e.jsxs(T,{children:[e.jsx(n,{children:"Date"}),e.jsx(n,{children:"Partner"}),e.jsx(n,{children:"Lead Name"}),e.jsx(n,{children:"Email"}),e.jsx(n,{children:"Phone"}),e.jsx(n,{children:"Company"}),e.jsx(n,{children:"Event"}),e.jsx(n,{children:"Status"}),e.jsx(n,{children:"Flags"}),e.jsx(n,{children:"Deal"}),e.jsx(n,{children:"Actions"})]})}),e.jsxs(me,{children:[I.map(a=>e.jsxs(T,{children:[e.jsx(r,{className:"whitespace-nowrap",children:le(new Date(a.created_at),"MMM d, yyyy")}),e.jsxs(r,{children:[e.jsx("div",{className:"font-medium",children:B(a)}),a.partners?.slug&&e.jsx("div",{className:"text-xs text-muted-foreground",children:a.partners.slug})]}),e.jsx(r,{children:q(a)}),e.jsx(r,{children:a.lead_email?e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"truncate max-w-[150px]",children:a.lead_email}),e.jsx(i,{size:"icon",variant:"ghost",className:"h-6 w-6",onClick:()=>se(a.lead_email),children:e.jsx(he,{className:"h-3 w-3"})})]}):"—"}),e.jsx(r,{children:a.lead_phone||"—"}),e.jsx(r,{children:a.lead_company||"—"}),e.jsx(r,{children:a.event_type?e.jsx(m,{variant:"outline",className:"text-xs",children:a.event_type}):"—"}),e.jsx(r,{children:e.jsx(m,{variant:w[a.status]?.variant||"outline",children:w[a.status]?.label||a.status})}),e.jsx(r,{children:e.jsxs("div",{className:"flex gap-1",children:[a.needs_approval&&e.jsxs(m,{variant:"outline",className:"text-xs bg-yellow-500/10 text-yellow-600 border-yellow-500/30",children:[e.jsx(ue,{className:"h-3 w-3 mr-1"}),"Approval"]}),a.duplicate&&e.jsx(m,{variant:"outline",className:"text-xs",children:"Dup"})]})}),e.jsx(r,{children:a.deal_id?e.jsxs(i,{size:"sm",variant:"link",className:"p-0 h-auto",onClick:()=>P.visit(`/admin/deals?dealId=${a.deal_id}`),children:[e.jsx(H,{className:"h-3 w-3 mr-1"}),"View"]}):"—"}),e.jsx(r,{children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx(i,{size:"sm",variant:"ghost",onClick:()=>{F(a),v(!0)},children:"Details"}),a.status==="new"&&e.jsxs(e.Fragment,{children:[e.jsx(i,{size:"sm",variant:"ghost",className:"text-green-600",onClick:()=>O(a),children:e.jsx(je,{className:"h-4 w-4"})}),e.jsx(i,{size:"sm",variant:"ghost",className:"text-destructive",onClick:()=>{F(a),p(!0)},children:e.jsx(fe,{className:"h-4 w-4"})})]})]})})]},a.id)),I.length===0&&e.jsx(T,{children:e.jsx(r,{colSpan:11,className:"text-center py-8 text-muted-foreground",children:"No referrals found"})})]})]})})})]}),e.jsx(z,{open:Z,onOpenChange:v,children:e.jsxs(M,{className:"max-w-lg",children:[e.jsx(V,{children:e.jsx(Q,{children:"Referral Details"})}),s&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Name:"})," ",q(s)]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Email:"})," ",s.lead_email||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Phone:"})," ",s.lead_phone||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Company:"})," ",s.lead_company||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Partner:"})," ",B(s)]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Source:"})," ",s.source||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Event:"})," ",s.event_type||"N/A"]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Status:"})," ",e.jsx(m,{variant:w[s.status]?.variant,children:w[s.status]?.label||s.status})]})]}),s.duplicate&&e.jsx(m,{variant:"outline",className:"bg-orange-500/10 text-orange-600",children:"Marked as Duplicate"}),s.needs_approval&&e.jsx(m,{variant:"outline",className:"bg-yellow-500/10 text-yellow-600",children:"Needs Approval"}),s.notes&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground text-sm",children:"Notes:"}),e.jsx("p",{className:"mt-1 text-sm bg-muted p-2 rounded",children:s.notes})]}),s.rejection_reason&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground text-sm",children:"Rejection Reason:"}),e.jsx("p",{className:"mt-1 text-sm bg-destructive/10 text-destructive p-2 rounded",children:s.rejection_reason})]}),s.deal_id&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground text-sm",children:"Linked Deal:"}),e.jsxs(i,{size:"sm",variant:"link",onClick:()=>P.visit(`/admin/deals?dealId=${s.deal_id}`),children:[e.jsx(H,{className:"h-3 w-3 mr-1"}),"View Deal"]})]})]}),e.jsx(U,{children:s?.status==="new"&&e.jsxs(e.Fragment,{children:[e.jsx(i,{variant:"outline",onClick:()=>{p(!0)},disabled:h,children:"Reject"}),e.jsxs(i,{onClick:()=>O(s),disabled:h,children:[h?e.jsx(R,{className:"h-4 w-4 animate-spin mr-2"}):null,"Accept"]})]})})]})}),e.jsx(z,{open:ee,onOpenChange:a=>{p(a),a||C("")},children:e.jsxs(M,{children:[e.jsx(V,{children:e.jsx(Q,{children:"Reject Referral"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Please provide a reason for rejecting this referral. This will be recorded but not shown to the partner."}),e.jsxs("div",{children:[e.jsx(pe,{htmlFor:"rejection-reason",children:"Rejection Reason *"}),e.jsx(xe,{id:"rejection-reason",placeholder:"e.g., Lead already exists in CRM, Invalid contact info, etc.",value:u,onChange:a=>C(a.target.value),className:"mt-1"})]})]}),e.jsxs(U,{children:[e.jsx(i,{variant:"outline",onClick:()=>p(!1),children:"Cancel"}),e.jsxs(i,{variant:"destructive",onClick:ae,disabled:h||!u.trim(),children:[h?e.jsx(R,{className:"h-4 w-4 animate-spin mr-2"}):null,"Reject Referral"]})]})]})})]})}export{ze as default};
