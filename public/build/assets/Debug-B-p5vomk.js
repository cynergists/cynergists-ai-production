import{c as ce,u as k,as as K,h as b,s as c,r as v,j as e,H as de,n as h,e as u,Q as oe,U as he,B as g,J as y,aN as ue}from"./app-C9sJHYCL.js";import{C as o,b as N,d as w,a as m,c as me}from"./card-xM_T_QEq.js";import{S as xe}from"./switch-CgUnYb0N.js";import{L as _}from"./label-CON6LZW3.js";import{T as je,a as pe,b as q,c as D}from"./tabs-BywZ5jok.js";import{I as ge}from"./input-BIyZmrfA.js";import{S as F,a as A,b as H,c as L,d}from"./select-Bb_vAbk5.js";import{T as W,a as R,b as j,c as n,d as B,e as r}from"./table-DvSgZRYl.js";import{D as be,g as fe,a as ve,c as ye,d as Ne,e as we}from"./dialog-DAfnVAW3.js";import{S as _e}from"./scroll-area-C84zghn6.js";import{u as Q}from"./useMutation-Dhp3buk0.js";import{Z as U}from"./zap-DQolQhLF.js";import{T as ke}from"./triangle-alert-BgzkvxgC.js";import{A as Ce}from"./activity-DTT9PKge.js";import{P as I}from"./play-Bn-FlGc-.js";import{R as T}from"./refresh-cw-DieGtOyq.js";import{E as Se}from"./eye-B3-dt3tC.js";/* empty css            */import"./index-H_9W4N8N.js";import"./index-B3oBxWiH.js";import"./index-DWjtwfXH.js";import"./index-mEKJzlVy.js";import"./index-BdQq_4o_.js";import"./Combination-Bv4OtcuM.js";import"./check-BybgecC6.js";import"./chevron-up-CyWMtqZ2.js";import"./index-qTvOvuVq.js";const Te=[["path",{d:"m8 2 1.88 1.88",key:"fmnt4t"}],["path",{d:"M14.12 3.88 16 2",key:"qol33r"}],["path",{d:"M9 7.13v-1a3.003 3.003 0 1 1 6 0v1",key:"d7y7pr"}],["path",{d:"M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6",key:"xs1cw7"}],["path",{d:"M12 20v-9",key:"1qisl0"}],["path",{d:"M6.53 9C4.6 8.8 3 7.1 3 5",key:"32zzws"}],["path",{d:"M6 13H2",key:"82j7cp"}],["path",{d:"M3 21c0-2.1 1.7-3.9 3.8-4",key:"4p0ekp"}],["path",{d:"M20.97 5c0 2.1-1.6 3.8-3.5 4",key:"18gb23"}],["path",{d:"M22 13h-4",key:"1jl80f"}],["path",{d:"M17.2 17c2.1.1 3.8 1.9 3.8 4",key:"k3fwyw"}]],Ee=ce("Bug",Te);function Me(){return k({queryKey:["test-mode"],queryFn:async()=>{const{data:t,error:a}=await c.rpc("get_test_mode");if(a)throw a;return t}})}function Pe(){const t=K();return Q({mutationFn:async a=>{const{data:l,error:i}=await c.rpc("set_test_mode",{enabled:a});if(i)throw i;return l},onSuccess:()=>{t.invalidateQueries({queryKey:["test-mode"]}),b.success("TEST_MODE updated")},onError:a=>{b.error("Failed to update TEST_MODE: "+a.message)}})}function qe(t){return k({queryKey:["webhook-events",t],queryFn:async()=>{let a=c.from("webhook_events").select("*").order("received_at",{ascending:!1}).limit(t?.limit||50);t?.status&&(a=a.eq("status",t.status)),t?.provider&&(a=a.eq("provider",t.provider));const{data:l,error:i}=await a;if(i)throw i;return l}})}function De(t){return k({queryKey:["attribution-events",t],queryFn:async()=>{let a=c.from("attribution_events").select("*").order("created_at",{ascending:!1}).limit(t?.limit||50);t?.event_type&&(a=a.eq("event_type",t.event_type)),t?.partner_slug&&(a=a.ilike("partner_slug",`%${t.partner_slug}%`));const{data:l,error:i}=await a;if(i)throw i;return l}})}function Fe(){return k({queryKey:["debug-health-stats"],queryFn:async()=>{const t=new Date(Date.now()-864e5).toISOString(),{count:a}=await c.from("webhook_events").select("*",{count:"exact",head:!0}).eq("status","failed").gte("received_at",t),{count:l}=await c.from("attribution_events").select("*",{count:"exact",head:!0}).gte("created_at",t),{count:i}=await c.from("partner_commissions").select("*",{count:"exact",head:!0}).gte("created_at",t),{count:p}=await c.from("partner_payouts").select("*",{count:"exact",head:!0}).gte("created_at",t),{count:E}=await c.from("partner_commissions").select("*",{count:"exact",head:!0}).eq("status","clawed_back").gte("updated_at",t);return{failedWebhooks24h:a||0,attributionEvents24h:l||0,commissionsCreated24h:i||0,payoutsCreated24h:p||0,commissionsClawedBack24h:E||0}},refetchInterval:3e4})}function Ae(){const t=K();return Q({mutationFn:async a=>{const{data:{session:l}}=await c.auth.getSession();if(!l)throw new Error("Not authenticated");const i=await c.functions.invoke("replay-webhook",{body:{webhookEventId:a}});if(i.error)throw i.error;return i.data},onSuccess:()=>{t.invalidateQueries({queryKey:["webhook-events"]}),t.invalidateQueries({queryKey:["debug-health-stats"]}),b.success("Webhook replayed successfully")},onError:a=>{b.error("Failed to replay webhook: "+a.message)}})}function He(){const t=K();return Q({mutationFn:async({eventType:a,partnerSlug:l})=>{const{data:{session:i}}=await c.auth.getSession();if(!i)throw new Error("Not authenticated");const p=await c.functions.invoke("generate-test-event",{body:{eventType:a,partnerSlug:l}});if(p.error)throw p.error;return p.data},onSuccess:a=>{t.invalidateQueries({queryKey:["webhook-events"]}),t.invalidateQueries({queryKey:["attribution-events"]}),t.invalidateQueries({queryKey:["debug-health-stats"]}),b.success(`Test ${a.result?.type} generated`)},onError:a=>{b.error("Failed to generate test event: "+a.message)}})}function hs(){const[t,a]=v.useState(""),[l,i]=v.useState(""),[p,E]=v.useState(""),[G,J]=v.useState(""),[Z,Y]=v.useState(null),{data:M,isLoading:X}=Me(),O=Pe(),{data:f,isLoading:C,refetch:Le}=Fe(),{data:V,isLoading:ee,refetch:se}=qe({status:t||void 0,provider:l||void 0}),{data:z,isLoading:te,refetch:ae}=De({event_type:p||void 0,partner_slug:G||void 0}),P=Ae(),x=He(),{data:$,isLoading:re,refetch:ne}=k({queryKey:["debug-payments"],queryFn:async()=>{const{data:s,error:S}=await c.from("payments").select("id, square_payment_id, amount, currency, status, captured_at, refunded_at, deal_id, partner_id").order("captured_at",{ascending:!1}).limit(50);if(S)throw S;return s}}),ie=s=>{switch(s){case"processed":return e.jsx(u,{className:"bg-green-500/20 text-green-400 border-green-500/30",children:"Processed"});case"failed":return e.jsx(u,{variant:"destructive",children:"Failed"});case"received":return e.jsx(u,{className:"bg-blue-500/20 text-blue-400 border-blue-500/30",children:"Received"});case"ignored":return e.jsx(u,{className:"bg-muted text-muted-foreground",children:"Ignored"});default:return e.jsx(u,{variant:"outline",children:s})}},le=s=>{const S={landing_view:"bg-blue-500/20 text-blue-400 border-blue-500/30",form_submit:"bg-green-500/20 text-green-400 border-green-500/30",booked_call:"bg-purple-500/20 text-purple-400 border-purple-500/30",paid_checkout:"bg-amber-500/20 text-amber-400 border-amber-500/30"};return e.jsx(u,{className:S[s]||"bg-muted",children:s})};return e.jsxs("div",{className:"space-y-6",children:[e.jsx(de,{children:e.jsx("title",{children:"Debug Console | Admin"})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(Ee,{className:"h-6 w-6"}),"Developer Debug Console"]}),e.jsx("p",{className:"text-muted-foreground",children:"Monitor webhooks, attribution events, and system health"})]}),e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_,{htmlFor:"test-mode",className:"font-medium",children:"TEST_MODE"}),X?e.jsx(h,{className:"h-4 w-4 animate-spin"}):e.jsx(xe,{id:"test-mode",checked:M||!1,onCheckedChange:s=>O.mutate(s),disabled:O.isPending})]}),M&&e.jsxs(u,{className:"bg-amber-500/20 text-amber-400 border-amber-500/30",children:[e.jsx(U,{className:"h-3 w-3 mr-1"}),"Test Mode Active"]})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(o,{className:f?.failedWebhooks24h?"border-destructive":"",children:[e.jsx(N,{className:"pb-2",children:e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(ke,{className:"h-4 w-4"}),"Failed Webhooks (24h)"]})}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold",children:C?e.jsx(h,{className:"h-6 w-6 animate-spin"}):f?.failedWebhooks24h||0})})]}),e.jsxs(o,{children:[e.jsx(N,{className:"pb-2",children:e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(Ce,{className:"h-4 w-4"}),"Attribution Events (24h)"]})}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold",children:C?e.jsx(h,{className:"h-6 w-6 animate-spin"}):f?.attributionEvents24h||0})})]}),e.jsxs(o,{children:[e.jsx(N,{className:"pb-2",children:e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4"}),"Commissions Created (24h)"]})}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold",children:C?e.jsx(h,{className:"h-6 w-6 animate-spin"}):f?.commissionsCreated24h||0})})]}),e.jsxs(o,{children:[e.jsx(N,{className:"pb-2",children:e.jsxs(w,{className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4"}),"Payouts Created (24h)"]})}),e.jsx(m,{children:e.jsx("div",{className:"text-2xl font-bold",children:C?e.jsx(h,{className:"h-6 w-6 animate-spin"}):f?.payoutsCreated24h||0})})]})]}),M&&e.jsxs(o,{className:"border-amber-500/30 bg-amber-500/5",children:[e.jsxs(N,{children:[e.jsxs(me,{className:"text-lg flex items-center gap-2",children:[e.jsx(U,{className:"h-5 w-5 text-amber-500"}),"Test Event Generator"]}),e.jsx(w,{children:"Generate test events for debugging (only available in TEST_MODE)"})]}),e.jsx(m,{children:e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs(g,{variant:"outline",onClick:()=>x.mutate({eventType:"attribution"}),disabled:x.isPending,children:[x.isPending?e.jsx(h,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(I,{className:"h-4 w-4 mr-2"}),"Generate Test Attribution"]}),e.jsxs(g,{variant:"outline",onClick:()=>x.mutate({eventType:"payment"}),disabled:x.isPending,children:[x.isPending?e.jsx(h,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(I,{className:"h-4 w-4 mr-2"}),"Generate Test Payment Webhook"]}),e.jsxs(g,{variant:"outline",onClick:()=>x.mutate({eventType:"refund"}),disabled:x.isPending,children:[x.isPending?e.jsx(h,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(I,{className:"h-4 w-4 mr-2"}),"Generate Test Refund Webhook"]})]})})]}),e.jsxs(je,{defaultValue:"webhooks",className:"space-y-4",children:[e.jsxs(pe,{children:[e.jsx(q,{value:"webhooks",children:"Webhook Events"}),e.jsx(q,{value:"attribution",children:"Attribution Events"}),e.jsx(q,{value:"payments",children:"Payments"})]}),e.jsxs(D,{value:"webhooks",className:"space-y-4",children:[e.jsx(o,{children:e.jsx(m,{className:"pt-4",children:e.jsxs("div",{className:"flex flex-wrap gap-4 items-end",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Status"}),e.jsxs(F,{value:t,onValueChange:a,children:[e.jsx(A,{className:"w-[150px]",children:e.jsx(H,{placeholder:"All statuses"})}),e.jsxs(L,{children:[e.jsx(d,{value:"",children:"All statuses"}),e.jsx(d,{value:"received",children:"Received"}),e.jsx(d,{value:"processed",children:"Processed"}),e.jsx(d,{value:"failed",children:"Failed"}),e.jsx(d,{value:"ignored",children:"Ignored"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Provider"}),e.jsxs(F,{value:l,onValueChange:i,children:[e.jsx(A,{className:"w-[150px]",children:e.jsx(H,{placeholder:"All providers"})}),e.jsxs(L,{children:[e.jsx(d,{value:"",children:"All providers"}),e.jsx(d,{value:"square",children:"Square"}),e.jsx(d,{value:"ghl",children:"GHL"})]})]})]}),e.jsxs(g,{variant:"outline",onClick:()=>se(),children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Refresh"]})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-4",children:ee?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(h,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsxs(W,{children:[e.jsx(R,{children:e.jsxs(j,{children:[e.jsx(n,{children:"Provider"}),e.jsx(n,{children:"Event Type"}),e.jsx(n,{children:"Status"}),e.jsx(n,{children:"Received"}),e.jsx(n,{children:"Processed"}),e.jsx(n,{children:"Error"}),e.jsx(n,{children:"Actions"})]})}),e.jsx(B,{children:V?.length===0?e.jsx(j,{children:e.jsx(r,{colSpan:7,className:"text-center text-muted-foreground py-8",children:"No webhook events found"})}):V?.map(s=>e.jsxs(j,{children:[e.jsx(r,{children:e.jsx(u,{variant:"outline",children:s.provider})}),e.jsx(r,{className:"font-mono text-sm",children:s.event_type}),e.jsx(r,{children:ie(s.status)}),e.jsx(r,{className:"text-sm text-muted-foreground",children:y(new Date(s.received_at),"MMM d, HH:mm:ss")}),e.jsx(r,{className:"text-sm text-muted-foreground",children:s.processed_at?y(new Date(s.processed_at),"MMM d, HH:mm:ss"):"-"}),e.jsx(r,{className:"max-w-[200px] truncate text-sm text-destructive",children:s.error_message||"-"}),e.jsx(r,{children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(be,{children:[e.jsx(fe,{asChild:!0,children:e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>Y(s.payload_json),children:e.jsx(Se,{className:"h-4 w-4"})})}),e.jsxs(ve,{className:"max-w-2xl max-h-[80vh]",children:[e.jsxs(ye,{children:[e.jsx(Ne,{children:"Webhook Payload"}),e.jsxs(we,{children:[s.provider," - ",s.event_type]})]}),e.jsx(_e,{className:"h-[60vh]",children:e.jsx("pre",{className:"text-xs bg-muted p-4 rounded overflow-auto",children:JSON.stringify(Z,null,2)})})]})]}),s.status==="failed"&&e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>P.mutate(s.id),disabled:P.isPending,children:e.jsx(T,{className:`h-4 w-4 ${P.isPending?"animate-spin":""}`})})]})})]},s.id))})]})})})]}),e.jsxs(D,{value:"attribution",className:"space-y-4",children:[e.jsx(o,{children:e.jsx(m,{className:"pt-4",children:e.jsxs("div",{className:"flex flex-wrap gap-4 items-end",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Event Type"}),e.jsxs(F,{value:p,onValueChange:E,children:[e.jsx(A,{className:"w-[150px]",children:e.jsx(H,{placeholder:"All types"})}),e.jsxs(L,{children:[e.jsx(d,{value:"",children:"All types"}),e.jsx(d,{value:"landing_view",children:"Landing View"}),e.jsx(d,{value:"form_submit",children:"Form Submit"}),e.jsx(d,{value:"booked_call",children:"Booked Call"}),e.jsx(d,{value:"paid_checkout",children:"Paid Checkout"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{children:"Partner Slug"}),e.jsx(ge,{placeholder:"Search slug...",value:G,onChange:s=>J(s.target.value),className:"w-[200px]"})]}),e.jsxs(g,{variant:"outline",onClick:()=>ae(),children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Refresh"]})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-4",children:te?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(h,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsxs(W,{children:[e.jsx(R,{children:e.jsxs(j,{children:[e.jsx(n,{children:"Event Type"}),e.jsx(n,{children:"Partner Slug"}),e.jsx(n,{children:"UTM Source"}),e.jsx(n,{children:"Landing Page"}),e.jsx(n,{children:"Cookie"}),e.jsx(n,{children:"Created"})]})}),e.jsx(B,{children:z?.length===0?e.jsx(j,{children:e.jsx(r,{colSpan:6,className:"text-center text-muted-foreground py-8",children:"No attribution events found"})}):z?.map(s=>e.jsxs(j,{children:[e.jsx(r,{children:le(s.event_type)}),e.jsx(r,{className:"font-mono text-sm",children:s.partner_slug||"-"}),e.jsx(r,{className:"text-sm",children:s.utm_source||"-"}),e.jsx(r,{className:"max-w-[200px] truncate text-sm text-muted-foreground",children:s.landing_page_url||"-"}),e.jsx(r,{children:s.cookie_present?e.jsx(u,{className:"bg-green-500/20 text-green-400 border-green-500/30",children:"Yes"}):e.jsx(u,{variant:"outline",children:"No"})}),e.jsx(r,{className:"text-sm text-muted-foreground",children:y(new Date(s.created_at),"MMM d, HH:mm:ss")})]},s.id))})]})})})]}),e.jsxs(D,{value:"payments",className:"space-y-4",children:[e.jsx(o,{children:e.jsx(m,{className:"pt-4",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-sm font-medium",children:"Recent Payments (Last 50)"})]}),e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>ne(),children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Refresh"]})]})})}),e.jsx(o,{children:e.jsx(m,{className:"pt-4",children:re?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(h,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsxs(W,{children:[e.jsx(R,{children:e.jsxs(j,{children:[e.jsx(n,{children:"Captured"}),e.jsx(n,{children:"Status"}),e.jsx(n,{children:"Amount"}),e.jsx(n,{children:"Deal ID"}),e.jsx(n,{children:"Partner ID"}),e.jsx(n,{children:"Payment ID"}),e.jsx(n,{children:"Refunded"})]})}),e.jsx(B,{children:$?.length===0?e.jsx(j,{children:e.jsx(r,{colSpan:7,className:"text-center text-muted-foreground py-8",children:"No payments found"})}):$?.map(s=>e.jsxs(j,{children:[e.jsx(r,{className:"text-sm text-muted-foreground",children:s.captured_at?y(new Date(s.captured_at),"MMM d, HH:mm"):"—"}),e.jsx(r,{children:e.jsx(u,{className:s.status==="captured"?"bg-green-500/20 text-green-400 border-green-500/30":s.status==="refunded"?"bg-amber-500/20 text-amber-400 border-amber-500/30":s.status==="partial_refund"?"bg-orange-500/20 text-orange-400 border-orange-500/30":s.status==="failed"?"bg-red-500/20 text-red-400 border-red-500/30":"bg-muted",children:s.status})}),e.jsxs(r,{className:"font-medium",children:["$",s.amount.toFixed(2)," ",s.currency]}),e.jsx(r,{className:"font-mono text-xs",children:s.deal_id?s.deal_id.substring(0,8)+"...":"—"}),e.jsx(r,{className:"font-mono text-xs",children:s.partner_id?s.partner_id.substring(0,8)+"...":"—"}),e.jsx(r,{className:"font-mono text-xs max-w-[120px] truncate",children:s.square_payment_id}),e.jsx(r,{className:"text-sm text-muted-foreground",children:s.refunded_at?y(new Date(s.refunded_at),"MMM d, HH:mm"):"—"})]},s.id))})]})})})]})]})]})}export{hs as default};
