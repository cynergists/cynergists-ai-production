import{r as c,s as m,h as n,j as e,B as j,E as Q,K as u,m as f,t as W,g as R,e as Y}from"./app-4HzrmfBH.js";import{C as $,a as F}from"./card-Bm8wZBfx.js";import{I as Z}from"./input-CBRyo5y3.js";import{S as ee,a as se,b as ae,c as re,d as h}from"./select-B8OCnYr5.js";import{T as te,a as ne,b as w,c as x,d as ie,e as o}from"./table-B19ek79J.js";import{S as le,a as ce,b as oe,c as de,d as me}from"./sheet-DqfzPUJO.js";import{S as D}from"./skeleton-DjRgmFeK.js";import{R as E}from"./refresh-cw-DKWV9xk1.js";import{P as ue}from"./play-Bm-DGVc5.js";import{C as L}from"./circle-check-CNlsgO6M.js";import{B as A}from"./ban-b_o3tJWG.js";import{C as he}from"./circle-x-BjVJplgf.js";/* empty css            */import"./index-BdQq_4o_.js";import"./index-x88ZtXLl.js";import"./Combination-Qxmo0n5Z.js";import"./index-Bs0kLRia.js";import"./check-Cdb1fOfs.js";import"./chevron-up-D1ZX3dXR.js";import"./index-4TQD4Xfx.js";const xe={scheduled:{label:"Scheduled",variant:"secondary",icon:R},ready:{label:"Ready",variant:"default",icon:W},processing:{label:"Processing",variant:"outline",icon:f},paid:{label:"Paid",variant:"default",icon:L},failed:{label:"Failed",variant:"destructive",icon:he},canceled:{label:"Canceled",variant:"outline",icon:A}};function Le(){const[T,B]=c.useState([]),[z,b]=c.useState(!0),[y,H]=c.useState(""),[g,U]=c.useState("all"),[r,_]=c.useState(null),[C,q]=c.useState([]),[I,S]=c.useState(!1),[i,l]=c.useState(null);c.useEffect(()=>{d()},[]);const d=async()=>{b(!0);try{const{data:s,error:a}=await m.from("partner_payouts").select(`
          *,
          partner:partners(first_name, last_name, company_name, payout_provider, payout_last4)
        `).order("created_at",{ascending:!1});if(a)throw a;B(s||[])}catch(s){console.error("Error fetching payouts:",s),n.error("Failed to load payouts")}finally{b(!1)}},P=async s=>{S(!0);try{const{data:a,error:t}=await m.from("partner_commissions").select("id, payout_id, net_amount, earned_at, status, customer_id").eq("payout_id",s);if(t)throw t;const v=(a||[]).map(p=>({id:p.id,commission_id:p.id,amount:p.net_amount,commission:{earned_at:p.earned_at,status:p.status,customer_id:p.customer_id}}));q(v)}catch(a){console.error("Error fetching payout items:",a),n.error("Failed to load payout items")}finally{S(!1)}},V=s=>{_(s),P(s.id)},K=async s=>{l(`reconcile-${s}`);try{const{data:a,error:t}=await m.rpc("reconcile_payout",{p_payout_id:s});if(t)throw t;const v=a;n.success(`Reconciled: removed ${v?.removed_count||0} commissions`),d(),r?.id===s&&P(s)}catch(a){console.error("Error reconciling payout:",a),n.error("Failed to reconcile payout")}finally{l(null)}},O=async s=>{l(`ready-${s}`);try{const{error:a}=await m.from("partner_payouts").update({status:"ready"}).eq("id",s);if(a)throw a;n.success("Payout marked as ready"),d()}catch(a){console.error("Error marking ready:",a),n.error("Failed to mark payout as ready")}finally{l(null)}},X=async s=>{l(`execute-${s}`);try{const{error:a}=await m.from("partner_payouts").update({status:"processing"}).eq("id",s);if(a)throw a;n.info("Payout is now processing. Use 'Mark Paid' after completing transfer."),d()}catch(a){console.error("Error executing payout:",a),n.error("Failed to execute payout")}finally{l(null)}},G=async s=>{l(`paid-${s}`);try{const{data:a,error:t}=await m.rpc("mark_payout_paid",{p_payout_id:s});if(t)throw t;a?n.success("Payout marked as paid, commissions updated"):n.error("Failed to mark payout as paid"),d()}catch(a){console.error("Error marking paid:",a),n.error("Failed to mark payout as paid")}finally{l(null)}},J=async s=>{l(`cancel-${s}`);try{const{data:a,error:t}=await m.rpc("cancel_payout",{p_payout_id:s});if(t)throw t;a?n.success("Payout canceled, commissions released"):n.error("Cannot cancel this payout"),d(),r?.id===s&&_(null)}catch(a){console.error("Error canceling payout:",a),n.error("Failed to cancel payout")}finally{l(null)}},M=T.filter(s=>{const a=y===""||s.partner?.first_name?.toLowerCase().includes(y.toLowerCase())||s.partner?.last_name?.toLowerCase().includes(y.toLowerCase())||s.partner?.company_name?.toLowerCase().includes(y.toLowerCase()),t=g==="all"||s.status===g;return a&&t}),N=s=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(s),k=s=>{const a=xe[s]||{label:s,variant:"outline",icon:R},t=a.icon;return e.jsxs(Y,{variant:a.variant,className:"gap-1",children:[e.jsx(t,{className:"h-3 w-3"}),a.label]})};return e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Payouts"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage partner payout batches and execution"})]}),e.jsxs(j,{onClick:d,variant:"outline",size:"sm",children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),"Refresh"]})]}),e.jsx($,{children:e.jsx(F,{className:"pt-6",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Z,{placeholder:"Search by partner...",value:y,onChange:s=>H(s.target.value),className:"pl-10"})]}),e.jsxs(ee,{value:g,onValueChange:U,children:[e.jsx(se,{className:"w-48",children:e.jsx(ae,{placeholder:"Filter by status"})}),e.jsxs(re,{children:[e.jsx(h,{value:"all",children:"All Statuses"}),e.jsx(h,{value:"scheduled",children:"Scheduled"}),e.jsx(h,{value:"ready",children:"Ready"}),e.jsx(h,{value:"processing",children:"Processing"}),e.jsx(h,{value:"paid",children:"Paid"}),e.jsx(h,{value:"failed",children:"Failed"}),e.jsx(h,{value:"canceled",children:"Canceled"})]})]})]})})}),e.jsx($,{children:e.jsx(F,{className:"p-0",children:z?e.jsx("div",{className:"p-6 space-y-4",children:[...Array(5)].map((s,a)=>e.jsx(D,{className:"h-12 w-full"},a))}):e.jsxs(te,{children:[e.jsx(ne,{children:e.jsxs(w,{children:[e.jsx(x,{children:"Partner"}),e.jsx(x,{children:"Payout Date"}),e.jsx(x,{children:"Amount"}),e.jsx(x,{children:"Commissions"}),e.jsx(x,{children:"Status"}),e.jsx(x,{children:"Paid At"}),e.jsx(x,{className:"text-right",children:"Actions"})]})}),e.jsx(ie,{children:M.length===0?e.jsx(w,{children:e.jsx(o,{colSpan:7,className:"text-center py-12 text-muted-foreground",children:"No payouts found"})}):M.map(s=>e.jsxs(w,{className:"cursor-pointer hover:bg-muted/50",onClick:()=>V(s),children:[e.jsx(o,{children:e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:[s.partner?.first_name," ",s.partner?.last_name]}),s.partner?.company_name&&e.jsx("p",{className:"text-sm text-muted-foreground",children:s.partner.company_name})]})}),e.jsx(o,{children:s.payout_date?u(new Date(s.payout_date),"MMM d, yyyy"):u(new Date(s.batch_date),"MMM d, yyyy")}),e.jsx(o,{className:"font-medium",children:N(s.total_amount)}),e.jsx(o,{children:s.commission_count}),e.jsx(o,{children:k(s.status)}),e.jsx(o,{children:s.paid_at?u(new Date(s.paid_at),"MMM d, yyyy HH:mm"):"-"}),e.jsx(o,{className:"text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",onClick:a=>a.stopPropagation(),children:[["scheduled","ready"].includes(s.status)&&e.jsxs(e.Fragment,{children:[e.jsx(j,{size:"sm",variant:"outline",onClick:()=>K(s.id),disabled:i===`reconcile-${s.id}`,children:i===`reconcile-${s.id}`?e.jsx(f,{className:"h-4 w-4 animate-spin"}):e.jsx(E,{className:"h-4 w-4"})}),s.status==="scheduled"&&e.jsx(j,{size:"sm",variant:"secondary",onClick:()=>O(s.id),disabled:i===`ready-${s.id}`,children:i===`ready-${s.id}`?e.jsx(f,{className:"h-4 w-4 animate-spin"}):"Ready"}),e.jsx(j,{size:"sm",onClick:()=>X(s.id),disabled:i===`execute-${s.id}`,children:i===`execute-${s.id}`?e.jsx(f,{className:"h-4 w-4 animate-spin"}):e.jsx(ue,{className:"h-4 w-4"})})]}),s.status==="processing"&&e.jsxs(j,{size:"sm",onClick:()=>G(s.id),disabled:i===`paid-${s.id}`,children:[i===`paid-${s.id}`?e.jsx(f,{className:"h-4 w-4 animate-spin"}):e.jsx(L,{className:"h-4 w-4 mr-1"}),"Mark Paid"]}),!["paid","canceled"].includes(s.status)&&e.jsx(j,{size:"sm",variant:"ghost",onClick:()=>J(s.id),disabled:i===`cancel-${s.id}`,children:i===`cancel-${s.id}`?e.jsx(f,{className:"h-4 w-4 animate-spin"}):e.jsx(A,{className:"h-4 w-4"})})]})})]},s.id))})]})})}),e.jsx(le,{open:!!r,onOpenChange:()=>_(null),children:e.jsx(ce,{className:"w-[500px] sm:max-w-[500px]",children:r&&e.jsxs(e.Fragment,{children:[e.jsxs(oe,{children:[e.jsx(de,{children:"Payout Details"}),e.jsxs(me,{children:[r.partner?.first_name," ",r.partner?.last_name,r.partner?.company_name&&` â€¢ ${r.partner.company_name}`]})]}),e.jsxs("div",{className:"mt-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Amount"}),e.jsx("p",{className:"text-2xl font-bold",children:N(r.total_amount)})]}),e.jsxs("div",{className:"p-4 bg-muted rounded-lg",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Status"}),e.jsx("div",{className:"mt-1",children:k(r.status)})]})]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Payout Date"}),e.jsx("span",{children:r.payout_date?u(new Date(r.payout_date),"MMM d, yyyy"):"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Period"}),e.jsx("span",{children:r.period_start&&r.period_end?`${u(new Date(r.period_start),"MMM d")} - ${u(new Date(r.period_end),"MMM d, yyyy")}`:"-"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Payout Method"}),e.jsxs("span",{children:[r.partner?.payout_provider==="manual"?"Manual":"Direct Deposit",r.partner?.payout_last4&&` (****${r.partner.payout_last4})`]})]}),r.failure_reason&&e.jsxs("div",{className:"p-3 bg-destructive/10 text-destructive rounded-lg",children:[e.jsx("p",{className:"font-medium",children:"Failure Reason"}),e.jsx("p",{className:"text-sm",children:r.failure_reason})]})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-medium mb-3",children:["Included Commissions (",C.length,")"]}),I?e.jsx("div",{className:"space-y-2",children:[...Array(3)].map((s,a)=>e.jsx(D,{className:"h-10 w-full"},a))}):e.jsx("div",{className:"border rounded-lg divide-y max-h-[300px] overflow-y-auto",children:C.map(s=>e.jsxs("div",{className:"p-3 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:s.commission?.earned_at?u(new Date(s.commission.earned_at),"MMM d, yyyy"):"Unknown date"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.commission?.status||"Unknown status"})]}),e.jsx("p",{className:"font-medium",children:N(s.amount)})]},s.id))})]})]})]})})})]})}export{Le as default};
