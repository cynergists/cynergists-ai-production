import{r as u,w as pe,u as je,j as e,m as ge,t as U,B as f,H as Ne,aX as ye,e as E,R as be,E as _e,C as Y,K as S,a as ve,s as N,h as k,aY as K,aZ as Q,a_ as we}from"./app-Lw9toWEL.js";import{u as V}from"./useMutation-eEEOJFKL.js";import{C as y,a as b}from"./card-HJJ00fMS.js";import{I as Ce}from"./input-yF94Vncd.js";import{S as z,a as J,b as G,c as X,d as p}from"./select-DbGhKeTs.js";import{D as Se,g as ke,a as De,c as Pe,d as Me}from"./dialog-a7boSf8M.js";import{S as Re}from"./switch-CjarQMHA.js";import{L as Te}from"./label-BmZ0klfu.js";import{a as Le,C as Ee,s as M,b as Z,e as ee}from"./calendar-D-sUXNp2.js";import{P as Oe,a as qe,b as Fe}from"./popover-CLKur1-R.js";import{C as O}from"./CenteredDash-CU337Pka.js";import{e as le}from"./endOfDay-BOU20L8Q.js";import{R as se}from"./refresh-cw-C7Ou6zTi.js";import{D as te}from"./download-BJFp7sOo.js";import{C as ae}from"./credit-card-pJcqw7N1.js";import{T as Ae}from"./trending-up-DvuLVGDQ.js";import{U as Ie}from"./user-B6g2DlSq.js";import{E as Be}from"./eye-COYcjsCX.js";import{C as $e}from"./copy-joC8m2D-.js";import{E as He}from"./external-link-CeySBoG-.js";import{B as We}from"./building-2-D5XRUaKw.js";import{s as Ue,e as re,a as Ye}from"./subYears-DoOtRaaB.js";import{e as ne}from"./endOfMonth-B-xDjHGe.js";/* empty css            */import"./index-BdQq_4o_.js";import"./index-DVcw4AEI.js";import"./Combination-DTrGx453.js";import"./index-Di_FMiVt.js";import"./check-DtvS8aN0.js";import"./chevron-up-DIuzYlEQ.js";import"./index-BNissOqM.js";import"./index-Bewwc68W.js";function Ke(c,n){return Le(c,-1)}const Qe=[{value:"all",label:"All Time"},{value:"today",label:"Today"},{value:"this_week",label:"This Week"},{value:"this_month",label:"This Month"},{value:"this_year",label:"This Year"},{value:"last_week",label:"Last Week"},{value:"last_month",label:"Last Month"},{value:"last_year",label:"Last Year"},{value:"last_7",label:"Last 7 Days"},{value:"last_30",label:"Last 30 Days"},{value:"last_90",label:"Last 90 Days"},{value:"last_365",label:"Last 365 Days"},{value:"custom",label:"Custom Range"}];function Ve(c){const n=new Date;switch(c){case"today":return{from:we(n),to:le(n)};case"this_week":return{from:Q(n,{weekStartsOn:0}),to:ee(n,{weekStartsOn:0})};case"this_month":return{from:Z(n),to:ne(n)};case"this_year":return{from:K(n),to:re(n)};case"last_week":const x=Q(Ke(n),{weekStartsOn:0});return{from:x,to:ee(x,{weekStartsOn:0})};case"last_month":const D=Z(Ye(n));return{from:D,to:ne(D)};case"last_year":const o=K(Ue(n));return{from:o,to:re(o)};case"last_7":return{from:M(n,7),to:n};case"last_30":return{from:M(n,30),to:n};case"last_90":return{from:M(n,90),to:n};case"last_365":return{from:M(n,365),to:n};default:return{from:void 0,to:void 0}}}const R={captured:{label:"Completed",className:"bg-green-500/20 text-green-400 border-green-500/30"},pending:{label:"Pending",className:"bg-yellow-500/20 text-yellow-400 border-yellow-500/30"},failed:{label:"Failed",className:"bg-red-500/20 text-red-400 border-red-500/30"},refunded:{label:"Refunded",className:"bg-red-500/20 text-red-400 border-red-500/30"},partial_refund:{label:"Partial Refund",className:"bg-amber-500/20 text-amber-400 border-amber-500/30"}};function Ds(){const[c,n]=u.useState(""),[x,D]=u.useState("all"),[o,de]=u.useState("all"),[i,ie]=u.useState(),[r,ce]=u.useState(null),[T,q]=u.useState(!1),oe=pe(),j=u.useMemo(()=>o==="custom"?{from:i?.from,to:i?.to}:Ve(o),[o,i]);u.useEffect(()=>{(async()=>{const{data:t}=await N.from("payment_settings").select("payment_mode, test_mode").limit(1).single();t&&q(t.payment_mode==="sandbox"||t.test_mode===!0)})()},[]);const F=V({mutationFn:async s=>{const{error:t}=await N.from("payment_settings").update({payment_mode:s?"sandbox":"production",test_mode:s,updated_at:new Date().toISOString()}).eq("id","7b0efa71-e474-4b62-b9f6-309e51488b02");if(t)throw t;return s},onSuccess:s=>{q(s),k.success(s?"Test mode enabled - all payments will use Square Sandbox":"Live mode enabled - payments will be processed for real")},onError:s=>{k.error(`Failed to update payment mode: ${s.message}`)}}),{data:A,isLoading:me,error:I,refetch:ue,isFetching:ze}=je({queryKey:["payments-from-db"],queryFn:async()=>{const{data:s,error:t}=await N.from("payments").select("*").order("captured_at",{ascending:!1}).limit(500);if(t)throw t;const l=[...new Set(s?.filter(a=>a.client_id).map(a=>a.client_id))],m=[...new Set(s?.filter(a=>a.partner_id).map(a=>a.partner_id))];let v={};if(l.length>0){const{data:a}=await N.from("clients").select("id, name, email").in("id",l);a&&a.forEach(d=>{v[d.id]={name:d.name,email:d.email}})}let w={};if(m.length>0){const{data:a}=await N.from("partners").select("id, first_name, last_name").in("id",m);a&&a.forEach(d=>{w[d.id]={first_name:d.first_name||"",last_name:d.last_name||""}})}const C=s?.map(a=>({...a,client:a.client_id&&v[a.client_id]||null,partner:a.partner_id&&w[a.partner_id]||null}))||[],$=C.filter(a=>a.status==="captured"||a.status==="partial_refund"),H=$.reduce((a,d)=>a+(d.amount||0),0),W=C.reduce((a,d)=>a+(d.refund_amount||0),0);return{payments:C,summary:{totalRevenue:H,totalRefunds:W,netRevenue:H-W,completedCount:$.length,totalCount:C.length}}},staleTime:1e3*60*2}),g=V({mutationFn:async()=>{const{data:s,error:t}=await N.functions.invoke("sync-square-payments",{body:{days_back:90}});if(t)throw t;if(s.error)throw new Error(s.error);return s},onSuccess:s=>{k.success(`Synced ${s.synced.inserted} new, ${s.synced.updated} updated payments`),oe.invalidateQueries({queryKey:["payments-from-db"]})},onError:s=>{k.error(`Sync failed: ${s.message}`)}}),P=A?.payments||[],_=A?.summary,L=P.filter(s=>{if(x!=="all"&&s.status!==x)return!1;if(j.from||j.to){const l=s.captured_at?new Date(s.captured_at):null;if(!l||j.from&&l<j.from||j.to&&l>le(j.to))return!1}if(!c)return!0;const t=c.toLowerCase();return s.square_payment_id?.toLowerCase().includes(t)||s.client?.name?.toLowerCase().includes(t)||s.client?.email?.toLowerCase().includes(t)||s.square_customer_id?.includes(t)}),h=(s,t="USD")=>new Intl.NumberFormat("en-US",{style:"currency",currency:t}).format(s),xe=s=>{navigator.clipboard.writeText(s),k.success("Copied to clipboard")},B=s=>{const t=s.raw_json;if(t?.card_details?.card){const l=t.card_details.card;return`${l.card_brand||"Card"} •••• ${l.last_4||""}`}return t?.bank_account_details?.bank_name?t.bank_account_details.bank_name:t?.source_type==="BANK_ACCOUNT"?"ACH":t?.source_type==="CARD"?"Card":t?.source_type||"—"},he=s=>s.raw_json?.source_type==="BANK_ACCOUNT"?e.jsx(We,{className:"h-4 w-4 text-muted-foreground"}):e.jsx(ae,{className:"h-4 w-4 text-muted-foreground"}),fe=s=>{if(s.client?.name)return{name:s.client.name,email:s.client.email||void 0};const t=s.raw_json;if(t){const l=t.billing_address,m=t.buyer_email_address,v=t._customer_name,w=t._customer_company;if(v)return{name:v,email:m};if(w)return{name:w,email:m};if(l?.first_name||l?.last_name)return{name:[l.first_name,l.last_name].filter(Boolean).join(" "),email:m};if(m)return{name:m,email:void 0}}return null};return me?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(ge,{className:"h-8 w-8 animate-spin text-primary"})}):I?e.jsx("div",{className:"p-6",children:e.jsx(y,{className:"border-destructive/50",children:e.jsxs(b,{className:"flex items-center gap-4 p-6",children:[e.jsx(U,{className:"h-8 w-8 text-destructive"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:"Error Loading Payments"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:I.message})]}),e.jsxs(f,{variant:"outline",onClick:()=>ue(),className:"ml-auto",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Retry"]})]})})}):e.jsxs(e.Fragment,{children:[e.jsx(Ne,{children:e.jsx("title",{children:"Transactions | Admin"})}),e.jsxs("div",{className:"flex flex-col h-[calc(100vh-64px)] overflow-hidden",children:[e.jsxs("div",{className:"flex-shrink-0 p-6 pb-4 space-y-4 bg-background",children:[e.jsxs("div",{className:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Transactions"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[P.length," transactions stored"]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 border rounded-lg px-3 py-1.5 bg-muted/50",children:[e.jsx(ye,{className:`h-4 w-4 ${T?"text-amber-500":"text-muted-foreground"}`}),e.jsx(Te,{htmlFor:"test-mode",className:"text-sm font-medium cursor-pointer",children:"Test Mode"}),e.jsx(Re,{id:"test-mode",checked:T,onCheckedChange:s=>F.mutate(s),disabled:F.isPending}),T&&e.jsx(E,{variant:"outline",className:"bg-amber-500/20 text-amber-400 border-amber-500/30 text-xs",children:"Sandbox"})]}),e.jsxs(f,{variant:"outline",onClick:()=>g.mutate(),disabled:g.isPending,children:[e.jsx(te,{className:`h-4 w-4 mr-2 ${g.isPending?"animate-spin":""}`}),g.isPending?"Syncing...":"Sync from Square"]})]})]}),_&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(y,{children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ae,{className:"h-8 w-8 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:_.completedCount}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Completed"})]})]})})}),e.jsx(y,{children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(be,{className:"h-8 w-8 text-green-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:h(_.totalRevenue)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Gross Revenue"})]})]})})}),e.jsx(y,{children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ae,{className:"h-8 w-8 text-blue-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:h(_.netRevenue)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Net Revenue"})]})]})})}),e.jsx(y,{children:e.jsx(b,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(se,{className:"h-8 w-8 text-amber-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:h(_.totalRefunds)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Refunds"})]})]})})})]}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(_e,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Ce,{placeholder:"Search by payment ID, client name, or email...",value:c,onChange:s=>n(s.target.value),className:"pl-10"})]}),e.jsxs(z,{value:o,onValueChange:s=>de(s),children:[e.jsxs(J,{className:"w-[160px]",children:[e.jsx(Y,{className:"h-4 w-4 mr-2 text-muted-foreground"}),e.jsx(G,{placeholder:"Time Range"})]}),e.jsx(X,{children:Qe.map(s=>e.jsx(p,{value:s.value,children:s.label},s.value))})]}),o==="custom"&&e.jsxs(Oe,{children:[e.jsx(qe,{asChild:!0,children:e.jsxs(f,{variant:"outline",className:"w-[240px] justify-start text-left font-normal",children:[e.jsx(Y,{className:"mr-2 h-4 w-4"}),i?.from?i.to?e.jsxs(e.Fragment,{children:[S(i.from,"M/d/yy")," - ",S(i.to,"M/d/yy")]}):S(i.from,"M/d/yy"):e.jsx("span",{className:"text-muted-foreground",children:"Pick dates"})]})}),e.jsx(Fe,{className:"w-auto p-0",align:"start",children:e.jsx(Ee,{mode:"range",selected:i,onSelect:ie,numberOfMonths:2,className:ve("p-3 pointer-events-auto")})})]}),e.jsxs(z,{value:x,onValueChange:D,children:[e.jsx(J,{className:"w-[150px]",children:e.jsx(G,{placeholder:"Status"})}),e.jsxs(X,{children:[e.jsx(p,{value:"all",children:"All Status"}),e.jsx(p,{value:"captured",children:"Completed"}),e.jsx(p,{value:"pending",children:"Pending"}),e.jsx(p,{value:"refunded",children:"Refunded"}),e.jsx(p,{value:"partial_refund",children:"Partial Refund"}),e.jsx(p,{value:"failed",children:"Failed"})]})]})]})]}),e.jsx("div",{className:"flex-1 overflow-hidden px-6",children:P.length===0?e.jsx(y,{className:"border-amber-500/50",children:e.jsxs(b,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx(U,{className:"h-12 w-12 text-amber-500 mb-4"}),e.jsx("h3",{className:"font-semibold text-lg mb-2",children:"No Payments Found"}),e.jsx("p",{className:"text-sm text-muted-foreground text-center max-w-md mb-4",children:'Click "Sync from Square" to pull your payment history, or configure Square webhooks for automatic updates.'}),e.jsxs(f,{onClick:()=>g.mutate(),disabled:g.isPending,children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Sync Now"]})]})}):e.jsx("div",{className:"border rounded-lg h-full overflow-auto",children:e.jsxs("table",{className:"w-full caption-bottom text-sm",style:{tableLayout:"fixed",minWidth:"1000px"},children:[e.jsx("thead",{className:"[&_tr]:border-b sticky top-0 z-10 bg-background",children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"h-12 px-4 text-left align-middle font-medium text-muted-foreground",style:{width:"180px"},children:"Client"}),e.jsx("th",{className:"h-12 px-4 text-left align-middle font-medium text-muted-foreground",style:{width:"160px"},children:"Date"}),e.jsx("th",{className:"h-12 px-4 text-center align-middle font-medium text-muted-foreground",style:{width:"110px"},children:"Status"}),e.jsx("th",{className:"h-12 px-4 text-right align-middle font-medium text-muted-foreground",style:{width:"120px"},children:"Amount"}),e.jsx("th",{className:"h-12 px-4 text-left align-middle font-medium text-muted-foreground",style:{width:"140px"},children:"Source"}),e.jsx("th",{className:"h-12 px-4 text-left align-middle font-medium text-muted-foreground",style:{width:"140px"},children:"Partner"}),e.jsx("th",{className:"h-12 px-4 text-center align-middle font-medium text-muted-foreground",style:{width:"100px"},children:"Refund"}),e.jsx("th",{className:"h-12 px-4 text-center align-middle font-medium text-muted-foreground",style:{width:"70px"},children:"Actions"})]})}),e.jsx("tbody",{className:"[&_tr:last-child]:border-0",children:L.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"text-center py-12 text-muted-foreground",children:c||x!=="all"?"No payments match your filters":"No payments found"})}):L.map(s=>e.jsxs("tr",{className:"border-b hover:bg-muted/50",children:[e.jsx("td",{className:"p-4 align-middle",children:(()=>{const t=fe(s);return t?e.jsxs("div",{children:[e.jsx("div",{className:"font-medium truncate",children:t.name}),t.email&&e.jsx("div",{className:"text-xs text-muted-foreground truncate",children:t.email})]}):e.jsx(O,{})})()}),e.jsx("td",{className:"p-4 align-middle whitespace-nowrap",children:s.captured_at?S(new Date(s.captured_at),"MMM d, yyyy HH:mm"):"—"}),e.jsx("td",{className:"p-4 align-middle text-center",children:e.jsx(E,{className:R[s.status]?.className||"bg-muted",children:R[s.status]?.label||s.status})}),e.jsx("td",{className:"p-4 align-middle text-right font-medium",children:h(s.amount,s.currency)}),e.jsx("td",{className:"p-4 align-middle",children:e.jsxs("div",{className:"flex items-center gap-2",children:[he(s),e.jsx("span",{className:"text-sm truncate",children:B(s)})]})}),e.jsx("td",{className:"p-4 align-middle",children:s.partner?e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(Ie,{className:"h-3 w-3 text-muted-foreground"}),e.jsxs("span",{className:"truncate",children:[s.partner.first_name," ",s.partner.last_name]})]}):e.jsx(O,{})}),e.jsx("td",{className:"p-4 align-middle text-center",children:s.refund_amount?e.jsxs("span",{className:"text-destructive font-medium",children:["-",h(s.refund_amount,s.currency)]}):e.jsx(O,{})}),e.jsx("td",{className:"p-4 align-middle text-center",children:e.jsxs(Se,{children:[e.jsx(ke,{asChild:!0,children:e.jsx(f,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>ce(s),children:e.jsx(Be,{className:"h-4 w-4"})})}),e.jsxs(De,{className:"max-w-lg",children:[e.jsx(Pe,{children:e.jsx(Me,{children:"Payment Details"})}),r&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Payment ID:"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"font-mono text-xs break-all",children:r.square_payment_id}),e.jsx(f,{size:"icon",variant:"ghost",className:"h-5 w-5 shrink-0",onClick:()=>xe(r.square_payment_id),children:e.jsx($e,{className:"h-3 w-3"})})]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Status:"}),e.jsx("div",{children:e.jsx(E,{className:R[r.status]?.className,children:R[r.status]?.label||r.status})})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Amount:"}),e.jsx("div",{className:"font-medium text-lg",children:h(r.amount,r.currency)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Source:"}),e.jsx("div",{children:B(r)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Captured:"}),e.jsx("div",{children:r.captured_at?S(new Date(r.captured_at),"MMM d, yyyy HH:mm:ss"):"—"})]}),r.client&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Client:"}),e.jsx("div",{children:r.client.name})]}),r.partner&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Partner:"}),e.jsxs("div",{children:[r.partner.first_name," ",r.partner.last_name]})]}),r.refund_amount&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Refund:"}),e.jsxs("div",{className:"text-destructive font-medium",children:["-",h(r.refund_amount,r.currency)]})]}),r.square_order_id&&e.jsxs("div",{children:[e.jsx("span",{className:"text-muted-foreground",children:"Order ID:"}),e.jsx("div",{className:"font-mono text-xs",children:r.square_order_id})]})]}),r.raw_json?.receipt_url&&e.jsx(f,{variant:"outline",className:"w-full",asChild:!0,children:e.jsxs("a",{href:r.raw_json.receipt_url,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(He,{className:"h-4 w-4 mr-2"}),"View Receipt"]})})]})]})]})})]},s.id))})]})})}),e.jsx("div",{className:"flex-shrink-0 px-6 py-4 bg-background border-t",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Showing ",L.length," of ",P.length," payments"]})})})})]})]})}export{Ds as default};
